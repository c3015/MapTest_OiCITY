<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²é£Ÿåº—ãƒãƒƒãƒ—</title>
    <!-- Firebase SDK (å¿…é ˆ) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©
        let app;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.allRestaurants = []; // Firebaseã‹ã‚‰å–å¾—ã—ãŸå…¨åº—èˆ—ã‚’ä¿æŒ

        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼å‡¦ç†
        const initFirebase = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {};
                
                app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã€userIdã‚’è¨­å®š
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        // èªè¨¼å®Œäº†å¾Œã€ãƒã‚¤ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹
                        if (window.currentTab === 'mylist') {
                            window.fetchRestaurants();
                        }
                    } else {
                        // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®å ´åˆã€ä»®ã®IDã‚’ä½¿ç”¨
                        window.userId = crypto.randomUUID();
                    }
                    console.log("Firebase Auth Ready. User ID:", window.userId);
                });

            } catch (e) {
                console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ããªã„å ´åˆã§ã‚‚ã‚¢ãƒ—ãƒªè‡ªä½“ã¯å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™
            }
        };

        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«åˆæœŸåŒ–
        initFirebase();
    </script>

    <!-- Leaflet CSSã¨JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* åŸºæœ¬è¨­å®šã¨ãƒ•ã‚©ãƒ³ãƒˆ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        #app {
            display: flex;
            height: 100vh;
            max-width: 100vw;
        }

        /* ãƒãƒƒãƒ—ãƒ‘ãƒãƒ« */
        #map-container {
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
        #sidebar {
            width: 380px;
            max-width: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ) */
        @media (max-width: 768px) {
            #app {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: 50%;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
            #map-container {
                height: 50%;
            }
        }
        
        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ (ç¾åœ¨åœ°) */
        .leaflet-control-locate {
            margin-top: 10px;
        }
        .leaflet-control-locate a {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4s4-1.79 4-4s-1.79-4-4-4m8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06M12 21c-4.97 0-9-4.03-9-9s4.03-9 9-9s9 4.03 9 9s-4.03 9-9 9z'/%3E%3C/svg%3E") !important;
            background-size: 70%;
            background-position: center;
        }


        /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .tabs {
            display: flex;
            background-color: #e9ecef;
            border-bottom: 2px solid #ced4da;
        }
        .tabs > div {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: background-color 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tabs > div:hover {
            background-color: #dee2e6;
        }
        .tabs > div.active {
            color: #007bff;
            background-color: white;
            border-bottom-color: #007bff;
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  */
        #search-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        #search-form input, #search-form button {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        #search-form input {
            flex-grow: 1;
        }
        #search-form button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #search-form button:hover {
            background-color: #0056b3;
        }
        
        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
        .restaurant-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .restaurant-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        .restaurant-item h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .restaurant-item p {
            margin: 0.2rem 0;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .category-badge {
            background-color: #ff6b6b;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* ãƒã‚¤ãƒªã‚¹ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒƒãƒ— */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .filter-chips .chip {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .filter-chips .chip.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .stars {
            color: #ffc107;
            font-size: 1rem;
        }
        .price-range {
            font-weight: 600;
            color: #1e8312;
        }


        /* åº—èˆ—è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
        }
        #rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #rating-group label {
            font-weight: normal;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .add-button {
            width: 100%;
            padding: 1rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px #1e7e34;
        }
        .add-button:hover {
            background-color: #218838;
            box-shadow: 0 2px #1e7e34;
            transform: translateY(2px);
        }

        /* --- é£²é£Ÿåº—è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ« (è¿½åŠ åˆ†) --- */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-overlay.open {
            display: flex;
            opacity: 1;
        }

        .detail-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }

        .detail-overlay.open .detail-modal {
            transform: scale(1);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            z-index: 2001;
        }

        .detail-image-container {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .detail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
        
        .detail-image-placeholder {
            color: #6c757d;
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .detail-info {
            padding: 1.5rem;
        }

        .detail-name {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .detail-source {
            font-size: 0.8rem;
            color: #ff6b6b;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .detail-badges {
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f1f3f5;
            color: #495057;
        }

        .price-badge {
            background: #d4edda;
            color: #155724;
        }

        .detail-section {
            padding: 1rem 0;
            border-top: 1px solid #e0e0e0;
        }

        .detail-section h3 {
            font-size: 1rem;
            color: #999;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }

        .detail-item {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .detail-item span, .detail-item a {
            font-weight: 600;
            color: #333;
        }

        .detail-rating {
            font-size: 1.2rem;
            color: #ffc107;
            margin-bottom: 0.5rem;
        }
        
        .detail-memo {
            color: #666;
            font-style: italic;
        }
        /* End of Detail Overlay Styles */
    </style>
</head>
<body>

    <!-- é£²é£Ÿåº—è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ãƒ¢ãƒ¼ãƒ€ãƒ«) -->
    <div id="restaurant-detail-overlay" class="detail-overlay">
        <div class="detail-modal">
            <button class="close-btn" onclick="closeDetailOverlay()">âœ–ï¸</button>
            <div class="detail-content">
                <div id="detail-image-container" class="detail-image-container">
                    <img id="detail-image" src="" alt="åº—èˆ—ã®ã‚¤ãƒ¡ãƒ¼ã‚¸" class="detail-image">
                    <div id="detail-image-placeholder" class="detail-image-placeholder">
                        ğŸ“¸ ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
                <div class="detail-info">
                    <h2 id="detail-name" class="detail-name"></h2>
                    <p class="detail-source" id="detail-source"></p>
                    <div class="detail-badges">
                        <span id="detail-category" class="badge"></span>
                        <span id="detail-price" class="badge price-badge"></span>
                        <span id="detail-cuisine" class="badge"></span>
                    </div>
                    
                    <!-- Firebaseãƒ‡ãƒ¼ã‚¿ã®ã¿ã«å­˜åœ¨ã™ã‚‹æƒ…å ± -->
                    <div id="detail-my-info" class="detail-section">
                        <h3>è©•ä¾¡ã¨ãƒ¡ãƒ¢</h3>
                        <p id="detail-rating" class="detail-rating"></p>
                        <p id="detail-memo" class="detail-memo"></p>
                    </div>

                    <!-- OSMãƒ‡ãƒ¼ã‚¿ã«å­˜åœ¨ã™ã‚‹æƒ…å ± -->
                    <div class="detail-section">
                        <h3>åŸºæœ¬æƒ…å ±</h3>
                        <p id="detail-address" class="detail-item">ğŸ“ ä½æ‰€: <span></span></p>
                        <p id="detail-hours" class="detail-item">ğŸ• å–¶æ¥­æ™‚é–“: <span></span></p>
                        <p id="detail-phone" class="detail-item">ğŸ“ é›»è©±: <span></span></p>
                        <p id="detail-website" class="detail-item">ğŸŒ Webã‚µã‚¤ãƒˆ: <a id="detail-website-link" href="#" target="_blank"></a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Detail Overlay -->

    <div id="app">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ (æ¤œç´¢çµæœã¨ãƒ•ã‚©ãƒ¼ãƒ ) -->
        <div id="sidebar">
            <div class="tabs">
                <div onclick="switchTab('search')" class="active">å‘¨è¾ºæ¤œç´¢</div>
                <div onclick="switchTab('mylist')">ãƒã‚¤ãƒªã‚¹ãƒˆ</div>
                <div onclick="switchTab('add')">åº—èˆ—ç™»éŒ²</div>
            </div>
            
            <div id="search-tab" class="tab-content">
                <div id="search-form">
                    <input type="text" id="searchTerm" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." value="restaurant">
                    <button onclick="searchNearby()">æ¤œç´¢</button>
                </div>
                <div id="nearbyList">
                    <p style="text-align: center; color: #999; padding: 2rem;">åœ°å›³ã‚’æ“ä½œã—ã¦ã€æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>

            <div id="mylist-tab" class="tab-content" style="display: none;">
                <div class="filter-chips">
                    <div class="chip active" data-category="all" onclick="filterMyList('all')">å…¨ã¦</div>
                    <div class="chip" data-category="Restaurant" onclick="filterMyList('Restaurant')">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</div>
                    <div class="chip" data-category="Cafe" onclick="filterMyList('Cafe')">ã‚«ãƒ•ã‚§</div>
                    <div class="chip" data-category="Bar" onclick="filterMyList('Bar')">ãƒãƒ¼</div>
                    <!-- ä»–ã®ã‚«ãƒ†ã‚´ãƒªã‚‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ  -->
                </div>
                <input type="text" id="myListSearch" oninput="searchMyRestaurants()" placeholder="ãƒã‚¤ãƒªã‚¹ãƒˆã‚’æ¤œç´¢...">
                <div id="restaurantList">
                    <!-- Firebaseã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å…¥ã‚‹ -->
                </div>
            </div>

            <div id="add-tab" class="tab-content" style="display: none;">
                <p>åœ°å›³ä¸Šã®è¿½åŠ ã—ãŸã„å ´æ‰€ã‚’**ã‚¯ãƒªãƒƒã‚¯**ã—ã¦ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                <form id="add-form" onsubmit="event.preventDefault(); saveRestaurant();">
                    <div class="form-group">
                        <label for="coordinates">åº§æ¨™ (è‡ªå‹•å…¥åŠ›)</label>
                        <input type="text" id="coordinates" disabled>
                    </div>
                    <div class="form-group">
                        <label for="restaurantName">åº—èˆ—å *</label>
                        <input type="text" id="restaurantName" required>
                    </div>
                    <div class="form-group">
                        <label for="category">ã‚«ãƒ†ã‚´ãƒª *</label>
                        <select id="category" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="Restaurant">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</option>
                            <option value="Cafe">ã‚«ãƒ•ã‚§</option>
                            <option value="Bar">ãƒãƒ¼</option>
                            <option value="Fast Food">ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰</option>
                            <option value="Others">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è©•ä¾¡ (5æ®µéš)</label>
                        <div id="rating-group">
                            <input type="radio" id="star5" name="rating" value="5"><label for="star5">â˜…â˜…â˜…â˜…â˜… (5)</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4">â˜…â˜…â˜…â˜…â˜† (4)</label>
                            <input type="radio" id="star3" name="rating" value="3" checked><label for="star3">â˜…â˜…â˜…â˜†â˜† (3)</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2">â˜…â˜…â˜†â˜†â˜† (2)</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1">â˜…â˜†â˜†â˜†â˜† (1)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="priceRange">ä¾¡æ ¼å¸¯</label>
                        <select id="priceRange">
                            <option value="æœªè¨­å®š">æœªè¨­å®š</option>
                            <option value="ã€œÂ¥1,000">ã€œÂ¥1,000 (ä½)</option>
                            <option value="Â¥1,000ã€œÂ¥3,000">Â¥1,000ã€œÂ¥3,000 (ä¸­)</option>
                            <option value="Â¥3,000ã€œÂ¥8,000">Â¥3,000ã€œÂ¥8,000 (é«˜)</option>
                            <option value="Â¥8,000ã€œ">Â¥8,000ã€œ (é«˜ç´š)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">ãƒ¡ãƒ¢ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="add-button">ã“ã®å ´æ‰€ã‚’ãƒã‚¤ãƒªã‚¹ãƒˆã«ç™»éŒ²</button>
                    <div id="status" class="status" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script type="module">
        // ãƒãƒƒãƒ—ã€ãƒãƒ¼ã‚«ãƒ¼ã€çŠ¶æ…‹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let currentMarker = null; // åº—èˆ—ç™»éŒ²ç”¨ã®ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼
        let userLocationMarker = null; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
        let selectedLat = null;
        let selectedLng = null;
        window.currentTab = 'search';
        window.myListFilter = 'all';

        const categoryIcons = {
            'restaurant': 'ğŸ½ï¸',
            'cafe': 'â˜•',
            'fast_food': 'ğŸ”',
            'bar': 'ğŸ¸',
            'pub': 'ğŸº',
            'Restaurant': 'ğŸ½ï¸',
            'Cafe': 'â˜•',
            'Bar': 'ğŸ¸',
            'Fast Food': 'ğŸ”',
            'Others': 'ğŸ“Œ'
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
        window.onload = function () {
            initializeMap();
            getCurrentLocation();
        }

        function initializeMap() {
            // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–: æ±äº¬é§…å‘¨è¾ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸­å¿ƒã¨ã™ã‚‹
            map = L.map('map').setView([35.681236, 139.767125], 14);

            // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (åº—èˆ—ç™»éŒ²ç”¨)
            map.on('click', onMapClick);
        }

        // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç† (åº—èˆ—ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿)
        function onMapClick(e) {
            if (currentTab === 'add') {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                // æ—¢å­˜ã®ä¸€æ™‚ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }

                // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                currentMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("ç™»éŒ²äºˆå®šåœ°").openPopup();
                
                // åº§æ¨™ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®š
                selectedLat = lat;
                selectedLng = lng;
                document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                map.setView([lat, lng], map.getZoom());
            }
        }

        // ç¾åœ¨åœ°å–å¾—
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                console.error('Geolocation is not supported by your browser');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // åœ°å›³ã‚’ç¾åœ¨åœ°ã¸ç§»å‹•
                    map.setView([lat, lng], 16);

                    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­ç½®
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.circleMarker([lat, lng], {
                        radius: 8,
                        color: 'blue',
                        fillColor: '#007bff',
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("ç¾åœ¨åœ°");
                    
                    // åˆå›æ¤œç´¢ã‚’å®Ÿè¡Œ
                    searchNearby();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½ç½®ã§æ¤œç´¢ã‚’å®Ÿè¡Œ
                    searchNearby();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // å‘¨è¾ºã®é£²é£Ÿåº—ã‚’æ¤œç´¢ (Overpass API)
        window.searchNearby = async function() {
            const searchTerm = document.getElementById('searchTerm').value || 'restaurant';
            const center = map.getCenter();
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // Overpass QLã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
            // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚«ãƒ†ã‚´ãƒªã‚’æŸ”è»Ÿã«çµåˆ
            const queryCategory = searchTerm.toLowerCase().split(' ').map(s => `nwr[cuisine~"${s}",i][amenity~"restaurant|cafe|fast_food|bar|pub",i](poly:"${bbox}")`).join(';');
            const queryAmenity = `nwr[amenity~"${searchTerm}|restaurant|cafe|fast_food|bar|pub",i](poly:"${bbox}");`;

            const query = `
                [out:json][timeout:25];
                (
                    ${queryCategory}
                    ${queryAmenity}
                );
                out center;
            `;

            const apiUrl = "https://overpass-api.de/api/interpreter";

            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">OpenStreetMapã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...</p>';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: `data=${encodeURIComponent(query)}`
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                const restaurants = data.elements
                    .filter(el => el.tags && el.tags.name)
                    .map(el => ({
                        name: el.tags.name,
                        category: el.tags.amenity,
                        cuisine: el.tags.cuisine || null,
                        address: el.tags['addr:full'] || el.tags['addr:street'] || null,
                        phone: el.tags.phone || null,
                        website: el.tags.website || el.tags.url || null,
                        opening_hours: el.tags.opening_hours || null,
                        latitude: el.lat || (el.center && el.center.lat),
                        longitude: el.lon || (el.center && el.center.lon),
                        source: 'osm'
                    }));
                    
                displayNearbyRestaurants(restaurants);
                
            } catch (error) {
                console.error("Overpass APIã‚¨ãƒ©ãƒ¼:", error);
                nearbyList.innerHTML = '<p class="status error">æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }

        // æ¤œç´¢çµæœã‚’ãƒªã‚¹ãƒˆã¨ãƒãƒƒãƒ—ã«è¡¨ç¤º
        function displayNearbyRestaurants(restaurants) {
            // æ—¢å­˜ã®æ¤œç´¢çµæœãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ (ãƒ¦ãƒ¼ã‚¶ãƒ¼/ç™»éŒ²ãƒãƒ¼ã‚«ãƒ¼ã¯æ®‹ã™)
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && 
                    layer !== currentMarker && 
                    layer !== userLocationMarker &&
                    !layer.options.isMyRestaurant) {
                    map.removeLayer(layer);
                }
            });
            
            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '';
            
            if (restaurants.length === 0) {
                nearbyList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            restaurants.forEach((data) => {
                const icon = categoryIcons[data.category] || 'ğŸ´';
                const customIcon = L.divIcon({
                    html: `<div style="font-size: 24px;">${icon}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30]
                });
                
                const marker = L.marker([data.latitude, data.longitude], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>${data.name}</strong><br>
                        ${data.cuisine ? `æ–™ç†: ${data.cuisine}<br>` : ''}
                        ${data.address ? `ä½æ‰€: ${data.address}<br>` : ''}
                        <small>å‡ºå…¸: OpenStreetMap</small>
                    `);
                
                const categoryName = {
                    'restaurant': 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',
                    'cafe': 'ã‚«ãƒ•ã‚§',
                    'fast_food': 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰',
                    'bar': 'ãƒãƒ¼',
                    'pub': 'ãƒ‘ãƒ–'
                }[data.category] || data.category;
                
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${icon} ${data.name}
                        <span class="category-badge">${categoryName}</span>
                    </h4>
                    ${data.cuisine ? `<p>æ–™ç†: ${data.cuisine}</p>` : ''}
                    ${data.address ? `<p>ğŸ“ ${data.address}</p>` : ''}
                    ${data.opening_hours ? `<p>ğŸ• ${data.opening_hours}</p>` : ''}
                `;
                // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‹ãã€ãƒãƒƒãƒ—ç§»å‹•
                item.onclick = () => {
                    openDetailOverlay(data);
                    map.setView([data.latitude, data.longitude], 17);
                    marker.openPopup();
                };
                nearbyList.appendChild(item);
            });
        }
        
        // --- Firebase/ãƒã‚¤ãƒªã‚¹ãƒˆé–¢é€£é–¢æ•° ---

        // Firebaseã«åº—èˆ—æƒ…å ±ã‚’ä¿å­˜
        window.saveRestaurant = async function() {
            if (!db) {
                document.getElementById('status').textContent = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                document.getElementById('status').className = 'status error';
                document.getElementById('status').style.display = 'block';
                return;
            }

            const name = document.getElementById('restaurantName').value;
            const category = document.getElementById('category').value;
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            const rating = ratingEl ? parseInt(ratingEl.value) : 3;
            const priceRange = document.getElementById('priceRange').value;
            const description = document.getElementById('description').value;
            
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'none';

            if (!name || !category || !selectedLat || !selectedLng) {
                statusDiv.textContent = 'åº—åã€ã‚«ãƒ†ã‚´ãƒªã€ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                return;
            }
            
            const newRestaurant = {
                name: name,
                category: category,
                rating: rating,
                priceRange: priceRange,
                description: description,
                latitude: selectedLat,
                longitude: selectedLng,
                createdAt: new Date(),
                source: 'firebase', // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ˜è¨˜
                // æ³¨æ„: ç¾åœ¨ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å…±æœ‰ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã™
                // é€šå¸¸ã¯ /artifacts/${__app_id}/users/${userId}/restaurants ã«ä¿å­˜ã—ã¾ã™
            };

            try {
                // Firebaseã«ä¿å­˜ (ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å…±æœ‰ã®'restaurants'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜)
                const docRef = await addDoc(collection(db, "restaurants"), newRestaurant);
                
                statusDiv.textContent = 'ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼';
                statusDiv.className = 'status success';
                statusDiv.style.display = 'block';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('add-form').reset();
                document.getElementById('coordinates').value = '';
                
                // ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                    selectedLat = null;
                    selectedLng = null;
                }
                
                // ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã§è¡¨ç¤º
                openDetailOverlay({ ...newRestaurant, id: docRef.id });

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);

            } catch (e) {
                console.error("Firebaseã¸ã®æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                statusDiv.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
            }
        };

        // Firebaseã‹ã‚‰åº—èˆ—ãƒªã‚¹ãƒˆã‚’å–å¾—
        window.fetchRestaurants = async function() {
            if (!db) return;
            
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">ãƒã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                // 'createdAt'ã§æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦å–å¾—
                const q = query(collection(db, "restaurants"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                window.allRestaurants = [];
                querySnapshot.forEach((doc) => {
                    window.allRestaurants.push({ id: doc.id, source: 'firebase', ...doc.data() });
                });
                
                // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§è¡¨ç¤ºã‚’æ›´æ–°
                displayMyRestaurants(window.allRestaurants);
            } catch (error) {
                console.error("Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                listDiv.innerHTML = '<p class="status error">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        };

        // ãƒã‚¤ãƒªã‚¹ãƒˆã®è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°/æ¤œç´¢å¯¾å¿œï¼‰
        window.displayMyRestaurants = function(restaurants) {
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '';
            
            let filtered = restaurants;
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (window.myListFilter !== 'all') {
                filtered = filtered.filter(r => r.category === window.myListFilter);
            }
            
            // åº—åæ¤œç´¢ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
            const searchInput = document.getElementById('myListSearch').value.toLowerCase();
            if (searchInput) {
                filtered = filtered.filter(r => 
                    r.name.toLowerCase().includes(searchInput) ||
                    r.description.toLowerCase().includes(searchInput)
                );
            }

            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">æ¤œç´¢æ¡ä»¶ã«åˆã†åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            filtered.forEach((data) => {
                const stars = 'â˜…'.repeat(data.rating) + 'â˜†'.repeat(5 - data.rating);
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${categoryIcons[data.category] || 'ğŸ“Œ'} ${data.name}
                        <span class="category-badge">${data.category}</span>
                    </h4>
                    <p class="stars">${stars}</p>
                    <p class="price-range">${data.priceRange || 'æœªè¨­å®š'}</p>
                    <p>ãƒ¡ãƒ¢: ${data.description ? data.description.substring(0, 40) + (data.description.length > 40 ? '...' : '') : 'ãƒ¡ãƒ¢ãªã—'}</p>
                `;
                
                // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‹ã
                item.onclick = () => {
                    openDetailOverlay(data);
                    if (data.latitude && data.longitude) {
                         map.setView([data.latitude, data.longitude], 17);
                    }
                };
                listDiv.appendChild(item);
            });
        };

        // ãƒã‚¤ãƒªã‚¹ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        window.filterMyList = function(category) {
            window.myListFilter = category;
            
            document.querySelectorAll('#mylist-tab .filter-chips .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`#mylist-tab .filter-chips .chip[data-category="${category}"]`).classList.add('active');
            
            displayMyRestaurants(window.allRestaurants);
        };
        
        // ãƒã‚¤ãƒªã‚¹ãƒˆã®æ¤œç´¢
        window.searchMyRestaurants = function() {
             displayMyRestaurants(window.allRestaurants);
        }

        // --- UI/ã‚¿ãƒ–åˆ¶å¾¡é–¢æ•° ---

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        window.switchTab = function(tabName) {
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã® active ã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tabs > div').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tabs > div[onclick="switchTab('${tabName}')"]`).classList.add('active');

            window.currentTab = tabName;
            
            // ãƒã‚¤ãƒªã‚¹ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (tabName === 'mylist') {
                if (window.userId) {
                    fetchRestaurants();
                } else {
                    document.getElementById('restaurantList').innerHTML = '<p class="status error">èªè¨¼ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>';
                }
            } else if (tabName === 'add') {
                 // è¿½åŠ ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰ã€éå»ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã€è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®æº–å‚™
                 if (currentMarker) map.removeLayer(currentMarker);
                 document.getElementById('coordinates').value = '';
            }
        };

        // --- è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆ¶å¾¡é–¢æ•° ---

        // è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
        window.openDetailOverlay = function(restaurantData) {
            const overlay = document.getElementById('restaurant-detail-overlay');
            
            // UIè¦ç´ ã®å–å¾—
            const nameEl = document.getElementById('detail-name');
            const sourceEl = document.getElementById('detail-source');
            const categoryEl = document.getElementById('detail-category');
            const priceEl = document.getElementById('detail-price');
            const cuisineEl = document.getElementById('detail-cuisine');
            const addressEl = document.getElementById('detail-address').querySelector('span');
            const hoursEl = document.getElementById('detail-hours').querySelector('span');
            const phoneEl = document.getElementById('detail-phone').querySelector('span');
            const websiteEl = document.getElementById('detail-website-link');
            const myInfoEl = document.getElementById('detail-my-info');
            const ratingEl = document.getElementById('detail-rating');
            const memoEl = document.getElementById('detail-memo');
            
            // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠ (ä»Šå›ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¿)
            const imgEl = document.getElementById('detail-image');
            const imgPlaceholderEl = document.getElementById('detail-image-placeholder');
            
            // ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆ
            nameEl.textContent = restaurantData.name;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
            sourceEl.textContent = (restaurantData.source === 'firebase') ? 'å‡ºå…¸: ãƒã‚¤ãƒªã‚¹ãƒˆ (æ‰‹å‹•ç™»éŒ²)' : 'å‡ºå…¸: OpenStreetMap';
            
            // ã‚«ãƒ†ã‚´ãƒªã¨æ–™ç†
            categoryEl.textContent = restaurantData.category || 'æœªè¨­å®š';
            cuisineEl.textContent = restaurantData.cuisine ? `æ–™ç†: ${restaurantData.cuisine}` : '';
            cuisineEl.style.display = restaurantData.cuisine ? 'inline-block' : 'none';

            // OSM/å…±é€šæƒ…å ±
            addressEl.textContent = restaurantData.address || 'æƒ…å ±ãªã—';
            hoursEl.textContent = restaurantData.opening_hours || 'æƒ…å ±ãªã—';
            phoneEl.textContent = restaurantData.phone || 'æƒ…å ±ãªã—';
            
            // Webã‚µã‚¤ãƒˆ
            if (restaurantData.website) {
                websiteEl.href = restaurantData.website;
                websiteEl.textContent = restaurantData.website.replace(/https?:\/\//, '').split('/')[0];
                document.getElementById('detail-website').style.display = 'block';
            } else {
                document.getElementById('detail-website').style.display = 'none';
            }

            // Firebase (ãƒã‚¤ãƒªã‚¹ãƒˆ) å°‚ç”¨æƒ…å ±
            if (restaurantData.source === 'firebase') {
                myInfoEl.style.display = 'block';
                // ä¾¡æ ¼å¸¯ã®è¡¨ç¤ºè¨­å®š
                priceEl.textContent = restaurantData.priceRange || 'æœªè¨­å®š';
                priceEl.style.display = 'inline-block';
                
                // è©•ä¾¡ã‚¹ã‚¿ãƒ¼è¡¨ç¤º
                const rating = restaurantData.rating || 0;
                const stars = 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
                ratingEl.innerHTML = `<span style="font-size: 1.5rem;">${stars}</span> (${rating}.0)`;
                
                memoEl.textContent = restaurantData.description || 'ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“';
            } else {
                myInfoEl.style.display = 'none';
                priceEl.style.display = 'none'; // OSMãƒ‡ãƒ¼ã‚¿ã«ã¯ä¾¡æ ¼å¸¯ã‚¿ã‚°ãŒãªã„ãŸã‚éè¡¨ç¤º
            }
            
            // ç”»åƒï¼ˆç¾åœ¨ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‡¦ç†ã®ã¿ï¼‰
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒURLã®ä¾‹: https://placehold.co/600x250/007bff/ffffff?text=${encodeURIComponent(restaurantData.name)}
            imgEl.style.display = 'none';
            imgPlaceholderEl.style.display = 'flex';


            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            overlay.classList.add('open');
        };

        // è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤º
        window.closeDetailOverlay = function() {
            document.getElementById('restaurant-detail-overlay').classList.remove('open');
        };


    </script>
</body>
</html>
