<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食店マップ</title>
    <!-- Firebase SDK (必須) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // グローバル変数として定義
        let app;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.allRestaurants = []; // Firebaseから取得した全店舗を保持

        // Firebase初期化と認証処理
        const initFirebase = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : {};
                
                app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // 認証ロジック
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                // 認証状態の変更を監視し、userIdを設定
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        // 認証完了後、マイリストの読み込みを開始
                        if (window.currentTab === 'mylist') {
                            window.fetchRestaurants();
                        }
                    } else {
                        // 匿名ログインまたはログアウトの場合、仮のIDを使用
                        window.userId = crypto.randomUUID();
                    }
                    console.log("Firebase Auth Ready. User ID:", window.userId);
                });

            } catch (e) {
                console.error("Firebase初期化エラー:", e);
                // データベースが利用できない場合でもアプリ自体は動作するようにします
            }
        };

        // アプリ起動時に初期化
        initFirebase();
    </script>

    <!-- Leaflet CSSとJS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* 基本設定とフォント */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        /* メインコンテナ */
        #app {
            display: flex;
            height: 100vh;
            max-width: 100vw;
        }

        /* マップパネル */
        #map-container {
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* サイドパネル */
        #sidebar {
            width: 380px;
            max-width: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
        }

        /* レスポンシブデザイン (モバイル対応) */
        @media (max-width: 768px) {
            #app {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: 50%;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
            #map-container {
                height: 50%;
            }
        }
        
        /* ユーティリティボタン (現在地) */
        .leaflet-control-locate {
            margin-top: 10px;
        }
        .leaflet-control-locate a {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4s4-1.79 4-4s-1.79-4-4-4m8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06M12 21c-4.97 0-9-4.03-9-9s4.03-9 9-9s9 4.03 9 9s-4.03 9-9 9z'/%3E%3C/svg%3E") !important;
            background-size: 70%;
            background-position: center;
        }


        /* タブスタイル */
        .tabs {
            display: flex;
            background-color: #e9ecef;
            border-bottom: 2px solid #ced4da;
        }
        .tabs > div {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: background-color 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tabs > div:hover {
            background-color: #dee2e6;
        }
        .tabs > div.active {
            color: #007bff;
            background-color: white;
            border-bottom-color: #007bff;
        }

        /* タブコンテンツ */
        .tab-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* 検索フォーム */
        #search-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        #search-form input, #search-form button {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        #search-form input {
            flex-grow: 1;
        }
        #search-form button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #search-form button:hover {
            background-color: #0056b3;
        }
        
        /* リストアイテム */
        .restaurant-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .restaurant-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        .restaurant-item h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .restaurant-item p {
            margin: 0.2rem 0;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .category-badge {
            background-color: #ff6b6b;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* マイリストフィルターチップ */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .filter-chips .chip {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .filter-chips .chip.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .stars {
            color: #ffc107;
            font-size: 1rem;
        }
        .price-range {
            font-weight: 600;
            color: #1e8312;
        }


        /* 店舗追加フォーム */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
        }
        #rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #rating-group label {
            font-weight: normal;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .add-button {
            width: 100%;
            padding: 1rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px #1e7e34;
        }
        .add-button:hover {
            background-color: #218838;
            box-shadow: 0 2px #1e7e34;
            transform: translateY(2px);
        }

        /* --- 飲食店詳細オーバーレイのスタイル (追加分) --- */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* 初期状態は非表示 */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-overlay.open {
            display: flex;
            opacity: 1;
        }

        .detail-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }

        .detail-overlay.open .detail-modal {
            transform: scale(1);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            z-index: 2001;
        }

        .detail-image-container {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .detail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* 初期は非表示 */
        }
        
        .detail-image-placeholder {
            color: #6c757d;
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .detail-info {
            padding: 1.5rem;
        }

        .detail-name {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .detail-source {
            font-size: 0.8rem;
            color: #ff6b6b;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .detail-badges {
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #f1f3f5;
            color: #495057;
        }

        .price-badge {
            background: #d4edda;
            color: #155724;
        }

        .detail-section {
            padding: 1rem 0;
            border-top: 1px solid #e0e0e0;
        }

        .detail-section h3 {
            font-size: 1rem;
            color: #999;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }

        .detail-item {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .detail-item span, .detail-item a {
            font-weight: 600;
            color: #333;
        }

        .detail-rating {
            font-size: 1.2rem;
            color: #ffc107;
            margin-bottom: 0.5rem;
        }
        
        .detail-memo {
            color: #666;
            font-style: italic;
        }
        /* End of Detail Overlay Styles */
    </style>
</head>
<body>

    <!-- 飲食店詳細オーバーレイ (モーダル) -->
    <div id="restaurant-detail-overlay" class="detail-overlay">
        <div class="detail-modal">
            <button class="close-btn" onclick="closeDetailOverlay()">✖️</button>
            <div class="detail-content">
                <div id="detail-image-container" class="detail-image-container">
                    <img id="detail-image" src="" alt="店舗のイメージ" class="detail-image">
                    <div id="detail-image-placeholder" class="detail-image-placeholder">
                        📸 画像がありません
                    </div>
                </div>
                <div class="detail-info">
                    <h2 id="detail-name" class="detail-name"></h2>
                    <p class="detail-source" id="detail-source"></p>
                    <div class="detail-badges">
                        <span id="detail-category" class="badge"></span>
                        <span id="detail-price" class="badge price-badge"></span>
                        <span id="detail-cuisine" class="badge"></span>
                    </div>
                    
                    <!-- Firebaseデータのみに存在する情報 -->
                    <div id="detail-my-info" class="detail-section">
                        <h3>評価とメモ</h3>
                        <p id="detail-rating" class="detail-rating"></p>
                        <p id="detail-memo" class="detail-memo"></p>
                    </div>

                    <!-- OSMデータに存在する情報 -->
                    <div class="detail-section">
                        <h3>基本情報</h3>
                        <p id="detail-address" class="detail-item">📍 住所: <span></span></p>
                        <p id="detail-hours" class="detail-item">🕐 営業時間: <span></span></p>
                        <p id="detail-phone" class="detail-item">📞 電話: <span></span></p>
                        <p id="detail-website" class="detail-item">🌐 Webサイト: <a id="detail-website-link" href="#" target="_blank"></a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Detail Overlay -->

    <div id="app">
        <!-- サイドバー (検索結果とフォーム) -->
        <div id="sidebar">
            <div class="tabs">
                <div onclick="switchTab('search')" class="active">周辺検索</div>
                <div onclick="switchTab('mylist')">マイリスト</div>
                <div onclick="switchTab('add')">店舗登録</div>
            </div>
            
            <div id="search-tab" class="tab-content">
                <div id="search-form">
                    <input type="text" id="searchTerm" placeholder="ジャンルやキーワードを入力..." value="restaurant">
                    <button onclick="searchNearby()">検索</button>
                </div>
                <div id="nearbyList">
                    <p style="text-align: center; color: #999; padding: 2rem;">地図を操作して、検索ボタンを押してください。</p>
                </div>
            </div>

            <div id="mylist-tab" class="tab-content" style="display: none;">
                <div class="filter-chips">
                    <div class="chip active" data-category="all" onclick="filterMyList('all')">全て</div>
                    <div class="chip" data-category="Restaurant" onclick="filterMyList('Restaurant')">レストラン</div>
                    <div class="chip" data-category="Cafe" onclick="filterMyList('Cafe')">カフェ</div>
                    <div class="chip" data-category="Bar" onclick="filterMyList('Bar')">バー</div>
                    <!-- 他のカテゴリも必要に応じて追加 -->
                </div>
                <input type="text" id="myListSearch" oninput="searchMyRestaurants()" placeholder="マイリストを検索...">
                <div id="restaurantList">
                    <!-- Firebaseから読み込まれたデータがここに入る -->
                </div>
            </div>

            <div id="add-tab" class="tab-content" style="display: none;">
                <p>地図上の追加したい場所を**クリック**して位置を設定してください。</p>
                <form id="add-form" onsubmit="event.preventDefault(); saveRestaurant();">
                    <div class="form-group">
                        <label for="coordinates">座標 (自動入力)</label>
                        <input type="text" id="coordinates" disabled>
                    </div>
                    <div class="form-group">
                        <label for="restaurantName">店舗名 *</label>
                        <input type="text" id="restaurantName" required>
                    </div>
                    <div class="form-group">
                        <label for="category">カテゴリ *</label>
                        <select id="category" required>
                            <option value="">選択してください</option>
                            <option value="Restaurant">レストラン</option>
                            <option value="Cafe">カフェ</option>
                            <option value="Bar">バー</option>
                            <option value="Fast Food">ファストフード</option>
                            <option value="Others">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>評価 (5段階)</label>
                        <div id="rating-group">
                            <input type="radio" id="star5" name="rating" value="5"><label for="star5">★★★★★ (5)</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4">★★★★☆ (4)</label>
                            <input type="radio" id="star3" name="rating" value="3" checked><label for="star3">★★★☆☆ (3)</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2">★★☆☆☆ (2)</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1">★☆☆☆☆ (1)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="priceRange">価格帯</label>
                        <select id="priceRange">
                            <option value="未設定">未設定</option>
                            <option value="〜¥1,000">〜¥1,000 (低)</option>
                            <option value="¥1,000〜¥3,000">¥1,000〜¥3,000 (中)</option>
                            <option value="¥3,000〜¥8,000">¥3,000〜¥8,000 (高)</option>
                            <option value="¥8,000〜">¥8,000〜 (高級)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">メモ・レビュー</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="add-button">この場所をマイリストに登録</button>
                    <div id="status" class="status" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- マップ表示エリア -->
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script type="module">
        // マップ、マーカー、状態のグローバル変数
        let map;
        let currentMarker = null; // 店舗登録用の一時マーカー
        let userLocationMarker = null; // 現在地マーカー
        let selectedLat = null;
        let selectedLng = null;
        window.currentTab = 'search';
        window.myListFilter = 'all';

        const categoryIcons = {
            'restaurant': '🍽️',
            'cafe': '☕',
            'fast_food': '🍔',
            'bar': '🍸',
            'pub': '🍺',
            'Restaurant': '🍽️',
            'Cafe': '☕',
            'Bar': '🍸',
            'Fast Food': '🍔',
            'Others': '📌'
        };

        // ページ読み込み後にマップを初期化
        window.onload = function () {
            initializeMap();
            getCurrentLocation();
        }

        function initializeMap() {
            // マップの初期化: 東京駅周辺をデフォルトの中心とする
            map = L.map('map').setView([35.681236, 139.767125], 14);

            // OpenStreetMapのタイルレイヤーを追加
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // マップクリックイベント (店舗登録用)
            map.on('click', onMapClick);
        }

        // マップクリック時の処理 (店舗登録モード時のみ)
        function onMapClick(e) {
            if (currentTab === 'add') {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                // 既存の一時マーカーを削除
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }

                // 新しいマーカーを追加
                currentMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("登録予定地").openPopup();
                
                // 座標をフォームに設定
                selectedLat = lat;
                selectedLng = lng;
                document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                map.setView([lat, lng], map.getZoom());
            }
        }

        // 現在地取得
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                console.error('Geolocation is not supported by your browser');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // 地図を現在地へ移動
                    map.setView([lat, lng], 16);

                    // 現在地マーカーを設置
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.circleMarker([lat, lng], {
                        radius: 8,
                        color: 'blue',
                        fillColor: '#007bff',
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("現在地");
                    
                    // 初回検索を実行
                    searchNearby();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    // エラーの場合、デフォルトの位置で検索を実行
                    searchNearby();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // 周辺の飲食店を検索 (Overpass API)
        window.searchNearby = async function() {
            const searchTerm = document.getElementById('searchTerm').value || 'restaurant';
            const center = map.getCenter();
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // Overpass QLクエリを構築
            // 検索キーワードとカテゴリを柔軟に結合
            const queryCategory = searchTerm.toLowerCase().split(' ').map(s => `nwr[cuisine~"${s}",i][amenity~"restaurant|cafe|fast_food|bar|pub",i](poly:"${bbox}")`).join(';');
            const queryAmenity = `nwr[amenity~"${searchTerm}|restaurant|cafe|fast_food|bar|pub",i](poly:"${bbox}");`;

            const query = `
                [out:json][timeout:25];
                (
                    ${queryCategory}
                    ${queryAmenity}
                );
                out center;
            `;

            const apiUrl = "https://overpass-api.de/api/interpreter";

            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">OpenStreetMapからデータを検索中...</p>';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: `data=${encodeURIComponent(query)}`
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                const restaurants = data.elements
                    .filter(el => el.tags && el.tags.name)
                    .map(el => ({
                        name: el.tags.name,
                        category: el.tags.amenity,
                        cuisine: el.tags.cuisine || null,
                        address: el.tags['addr:full'] || el.tags['addr:street'] || null,
                        phone: el.tags.phone || null,
                        website: el.tags.website || el.tags.url || null,
                        opening_hours: el.tags.opening_hours || null,
                        latitude: el.lat || (el.center && el.center.lat),
                        longitude: el.lon || (el.center && el.center.lon),
                        source: 'osm'
                    }));
                    
                displayNearbyRestaurants(restaurants);
                
            } catch (error) {
                console.error("Overpass APIエラー:", error);
                nearbyList.innerHTML = '<p class="status error">検索に失敗しました。時間をおいて再試行してください。</p>';
            }
        }

        // 検索結果をリストとマップに表示
        function displayNearbyRestaurants(restaurants) {
            // 既存の検索結果マーカーを削除 (ユーザー/登録マーカーは残す)
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && 
                    layer !== currentMarker && 
                    layer !== userLocationMarker &&
                    !layer.options.isMyRestaurant) {
                    map.removeLayer(layer);
                }
            });
            
            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '';
            
            if (restaurants.length === 0) {
                nearbyList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">検索結果がありません</p>';
                return;
            }
            
            restaurants.forEach((data) => {
                const icon = categoryIcons[data.category] || '🍴';
                const customIcon = L.divIcon({
                    html: `<div style="font-size: 24px;">${icon}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30]
                });
                
                const marker = L.marker([data.latitude, data.longitude], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>${data.name}</strong><br>
                        ${data.cuisine ? `料理: ${data.cuisine}<br>` : ''}
                        ${data.address ? `住所: ${data.address}<br>` : ''}
                        <small>出典: OpenStreetMap</small>
                    `);
                
                const categoryName = {
                    'restaurant': 'レストラン',
                    'cafe': 'カフェ',
                    'fast_food': 'ファストフード',
                    'bar': 'バー',
                    'pub': 'パブ'
                }[data.category] || data.category;
                
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${icon} ${data.name}
                        <span class="category-badge">${categoryName}</span>
                    </h4>
                    ${data.cuisine ? `<p>料理: ${data.cuisine}</p>` : ''}
                    ${data.address ? `<p>📍 ${data.address}</p>` : ''}
                    ${data.opening_hours ? `<p>🕐 ${data.opening_hours}</p>` : ''}
                `;
                // リストアイテムクリックでオーバーレイを開き、マップ移動
                item.onclick = () => {
                    openDetailOverlay(data);
                    map.setView([data.latitude, data.longitude], 17);
                    marker.openPopup();
                };
                nearbyList.appendChild(item);
            });
        }
        
        // --- Firebase/マイリスト関連関数 ---

        // Firebaseに店舗情報を保存
        window.saveRestaurant = async function() {
            if (!db) {
                document.getElementById('status').textContent = 'データベースが初期化されていません。';
                document.getElementById('status').className = 'status error';
                document.getElementById('status').style.display = 'block';
                return;
            }

            const name = document.getElementById('restaurantName').value;
            const category = document.getElementById('category').value;
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            const rating = ratingEl ? parseInt(ratingEl.value) : 3;
            const priceRange = document.getElementById('priceRange').value;
            const description = document.getElementById('description').value;
            
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'none';

            if (!name || !category || !selectedLat || !selectedLng) {
                statusDiv.textContent = '店名、カテゴリ、位置を選択してください。';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                return;
            }
            
            const newRestaurant = {
                name: name,
                category: category,
                rating: rating,
                priceRange: priceRange,
                description: description,
                latitude: selectedLat,
                longitude: selectedLng,
                createdAt: new Date(),
                source: 'firebase', // データソースを明記
                // 注意: 現在は全ユーザー共有のコレクションに保存します
                // 通常は /artifacts/${__app_id}/users/${userId}/restaurants に保存します
            };

            try {
                // Firebaseに保存 (ここではシンプルに全ユーザー共有の'restaurants'コレクションに保存)
                const docRef = await addDoc(collection(db, "restaurants"), newRestaurant);
                
                statusDiv.textContent = '保存に成功しました！';
                statusDiv.className = 'status success';
                statusDiv.style.display = 'block';
                
                // フォームをリセット
                document.getElementById('add-form').reset();
                document.getElementById('coordinates').value = '';
                
                // マーカーを削除
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                    selectedLat = null;
                    selectedLng = null;
                }
                
                // 保存したデータをオーバーレイで表示
                openDetailOverlay({ ...newRestaurant, id: docRef.id });

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);

            } catch (e) {
                console.error("Firebaseへの書き込みエラー:", e);
                statusDiv.textContent = '保存に失敗しました。コンソールを確認してください。';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
            }
        };

        // Firebaseから店舗リストを取得
        window.fetchRestaurants = async function() {
            if (!db) return;
            
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">マイリストを読み込み中...</p>';

            try {
                // 'createdAt'で新しい順にソートして取得
                const q = query(collection(db, "restaurants"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                window.allRestaurants = [];
                querySnapshot.forEach((doc) => {
                    window.allRestaurants.push({ id: doc.id, source: 'firebase', ...doc.data() });
                });
                
                // 現在のフィルターで表示を更新
                displayMyRestaurants(window.allRestaurants);
            } catch (error) {
                console.error("Firebaseからのデータ取得エラー:", error);
                listDiv.innerHTML = '<p class="status error">リストの読み込みに失敗しました。</p>';
            }
        };

        // マイリストの表示（フィルタリング/検索対応）
        window.displayMyRestaurants = function(restaurants) {
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '';
            
            let filtered = restaurants;
            
            // カテゴリフィルター
            if (window.myListFilter !== 'all') {
                filtered = filtered.filter(r => r.category === window.myListFilter);
            }
            
            // 店名検索による絞り込み
            const searchInput = document.getElementById('myListSearch').value.toLowerCase();
            if (searchInput) {
                filtered = filtered.filter(r => 
                    r.name.toLowerCase().includes(searchInput) ||
                    r.description.toLowerCase().includes(searchInput)
                );
            }

            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">検索条件に合う店舗がありません</p>';
                return;
            }
            
            filtered.forEach((data) => {
                const stars = '★'.repeat(data.rating) + '☆'.repeat(5 - data.rating);
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${categoryIcons[data.category] || '📌'} ${data.name}
                        <span class="category-badge">${data.category}</span>
                    </h4>
                    <p class="stars">${stars}</p>
                    <p class="price-range">${data.priceRange || '未設定'}</p>
                    <p>メモ: ${data.description ? data.description.substring(0, 40) + (data.description.length > 40 ? '...' : '') : 'メモなし'}</p>
                `;
                
                // オーバーレイを開く
                item.onclick = () => {
                    openDetailOverlay(data);
                    if (data.latitude && data.longitude) {
                         map.setView([data.latitude, data.longitude], 17);
                    }
                };
                listDiv.appendChild(item);
            });
        };

        // マイリストのフィルタリング
        window.filterMyList = function(category) {
            window.myListFilter = category;
            
            document.querySelectorAll('#mylist-tab .filter-chips .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`#mylist-tab .filter-chips .chip[data-category="${category}"]`).classList.add('active');
            
            displayMyRestaurants(window.allRestaurants);
        };
        
        // マイリストの検索
        window.searchMyRestaurants = function() {
             displayMyRestaurants(window.allRestaurants);
        }

        // --- UI/タブ制御関数 ---

        // タブ切り替え
        window.switchTab = function(tabName) {
            // タブコンテンツの切り替え
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // タブボタンの active クラス切り替え
            document.querySelectorAll('.tabs > div').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tabs > div[onclick="switchTab('${tabName}')"]`).classList.add('active');

            window.currentTab = tabName;
            
            // マイリストタブに切り替えた時にデータを取得
            if (tabName === 'mylist') {
                if (window.userId) {
                    fetchRestaurants();
                } else {
                    document.getElementById('restaurantList').innerHTML = '<p class="status error">認証中です。しばらくお待ちください...</p>';
                }
            } else if (tabName === 'add') {
                 // 追加タブに切り替わったら、過去のマーカーを削除して、追加モードの準備
                 if (currentMarker) map.removeLayer(currentMarker);
                 document.getElementById('coordinates').value = '';
            }
        };

        // --- 詳細オーバーレイ制御関数 ---

        // 詳細オーバーレイ表示
        window.openDetailOverlay = function(restaurantData) {
            const overlay = document.getElementById('restaurant-detail-overlay');
            
            // UI要素の取得
            const nameEl = document.getElementById('detail-name');
            const sourceEl = document.getElementById('detail-source');
            const categoryEl = document.getElementById('detail-category');
            const priceEl = document.getElementById('detail-price');
            const cuisineEl = document.getElementById('detail-cuisine');
            const addressEl = document.getElementById('detail-address').querySelector('span');
            const hoursEl = document.getElementById('detail-hours').querySelector('span');
            const phoneEl = document.getElementById('detail-phone').querySelector('span');
            const websiteEl = document.getElementById('detail-website-link');
            const myInfoEl = document.getElementById('detail-my-info');
            const ratingEl = document.getElementById('detail-rating');
            const memoEl = document.getElementById('detail-memo');
            
            // 画像コンテナ (今回はプレースホルダーのみ)
            const imgEl = document.getElementById('detail-image');
            const imgPlaceholderEl = document.getElementById('detail-image-placeholder');
            
            // データのセット
            nameEl.textContent = restaurantData.name;
            
            // データソース
            sourceEl.textContent = (restaurantData.source === 'firebase') ? '出典: マイリスト (手動登録)' : '出典: OpenStreetMap';
            
            // カテゴリと料理
            categoryEl.textContent = restaurantData.category || '未設定';
            cuisineEl.textContent = restaurantData.cuisine ? `料理: ${restaurantData.cuisine}` : '';
            cuisineEl.style.display = restaurantData.cuisine ? 'inline-block' : 'none';

            // OSM/共通情報
            addressEl.textContent = restaurantData.address || '情報なし';
            hoursEl.textContent = restaurantData.opening_hours || '情報なし';
            phoneEl.textContent = restaurantData.phone || '情報なし';
            
            // Webサイト
            if (restaurantData.website) {
                websiteEl.href = restaurantData.website;
                websiteEl.textContent = restaurantData.website.replace(/https?:\/\//, '').split('/')[0];
                document.getElementById('detail-website').style.display = 'block';
            } else {
                document.getElementById('detail-website').style.display = 'none';
            }

            // Firebase (マイリスト) 専用情報
            if (restaurantData.source === 'firebase') {
                myInfoEl.style.display = 'block';
                // 価格帯の表示設定
                priceEl.textContent = restaurantData.priceRange || '未設定';
                priceEl.style.display = 'inline-block';
                
                // 評価スター表示
                const rating = restaurantData.rating || 0;
                const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
                ratingEl.innerHTML = `<span style="font-size: 1.5rem;">${stars}</span> (${rating}.0)`;
                
                memoEl.textContent = restaurantData.description || 'メモはありません';
            } else {
                myInfoEl.style.display = 'none';
                priceEl.style.display = 'none'; // OSMデータには価格帯タグがないため非表示
            }
            
            // 画像（現在はプレースホルダー処理のみ）
            // プレースホルダー画像URLの例: https://placehold.co/600x250/007bff/ffffff?text=${encodeURIComponent(restaurantData.name)}
            imgEl.style.display = 'none';
            imgPlaceholderEl.style.display = 'flex';


            // モーダルを表示
            overlay.classList.add('open');
        };

        // 詳細オーバーレイ非表示
        window.closeDetailOverlay = function() {
            document.getElementById('restaurant-detail-overlay').classList.remove('open');
        };


    </script>
</body>
</html>
