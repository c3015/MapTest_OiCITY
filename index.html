<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²é£Ÿåº—ãƒãƒƒãƒ—</title>
    <!-- Firebase SDK (å¿…é ˆ) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, getDocs, collection, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
        setLogLevel('debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©
        let app;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.allRestaurants = []; 
        window.isFirebaseReady = false; // Firebaseã®æº–å‚™çŠ¶æ…‹

        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼å‡¦ç†
        const initFirebase = async () => {
            let firebaseConfig = null;
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                }
                
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    // FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ•ãƒ©ã‚°è¨­å®š
                    console.warn("FirebaseåˆæœŸåŒ–å¤±æ•—: projectIdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ãƒªã‚¹ãƒˆæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                    document.getElementById('firebase-status').textContent = 'âš ï¸ ãƒã‚¤ãƒªã‚¹ãƒˆæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ (DBæœªè¨­å®š)';
                    return; 
                }
                
                app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        window.userId = crypto.randomUUID();
                    }
                    window.isFirebaseReady = true;
                    document.getElementById('firebase-status').textContent = 'âœ… ãƒã‚¤ãƒªã‚¹ãƒˆæ©Ÿèƒ½åˆ©ç”¨å¯èƒ½';
                    if (window.currentTab === 'mylist') {
                        window.fetchRestaurants();
                    }
                });

            } catch (e) {
                console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
                document.getElementById('firebase-status').textContent = `âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${e.message}`;
            }
        };

        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«åˆæœŸåŒ–
        initFirebase();
    </script>

    <!-- Leaflet CSSã¨JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* (å‰å›ã®CSSã¨ã»ã¼åŒã˜ã§ã™ãŒã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€éƒ¨æ›´æ–°) */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        #app {
            display: flex;
            height: 100vh;
            max-width: 100vw;
        }

        #map-container {
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #sidebar {
            width: 380px;
            max-width: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
        }

        @media (max-width: 768px) {
            #app {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: 50%;
            }
            #map-container {
                height: 50%;
            }
        }
        
        .tabs {
            display: flex;
            background-color: #e9ecef;
            border-bottom: 2px solid #ced4da;
        }
        .tabs > div {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: background-color 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tabs > div.active {
            color: #007bff;
            background-color: white;
            border-bottom-color: #007bff;
        }

        .tab-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        #search-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        #search-form input, #search-form button {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        #search-form button {
            background-color: #007bff;
        }

        .restaurant-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .restaurant-item h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        .category-badge {
            background-color: #ff6b6b;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-overlay.open {
            display: flex;
            opacity: 1;
        }

        .detail-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .detail-info {
            padding: 1.5rem;
        }

        .detail-section {
            padding: 1rem 0;
            border-top: 1px solid #e0e0e0;
        }
        
        .detail-section h3 {
            font-size: 1rem;
            color: #999;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }
        
        .detail-item {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

    </style>
</head>
<body>

    <!-- é£²é£Ÿåº—è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ãƒ¢ãƒ¼ãƒ€ãƒ«) -->
    <div id="restaurant-detail-overlay" class="detail-overlay">
        <div class="detail-modal">
            <button class="close-btn" onclick="closeDetailOverlay()">âœ–ï¸</button>
            <div class="detail-content">
                <div id="detail-image-container" class="detail-image-container">
                    <div id="detail-image-placeholder" class="detail-image-placeholder">
                        ğŸ½ï¸ åº—èˆ—ã‚¤ãƒ¡ãƒ¼ã‚¸
                    </div>
                </div>
                <div class="detail-info">
                    <h2 id="detail-name" class="detail-name"></h2>
                    <p class="detail-source" id="detail-source"></p>
                    <div class="detail-badges">
                        <span id="detail-category" class="badge"></span>
                        <span id="detail-price" class="badge price-badge"></span>
                        <span id="detail-cuisine" class="badge"></span>
                    </div>
                    
                    <!-- å¤–éƒ¨æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ (Gemini APIã®çµæœ) -->
                    <div id="detail-gemini-info">
                        <!-- æ¤œç´¢çµæœãŒã“ã“ã«å…¥ã‚Šã¾ã™ -->
                    </div>

                    <!-- OpenStreetMapã®åŸºæœ¬æƒ…å ± -->
                    <div class="detail-section">
                        <h3>åŸºæœ¬æƒ…å ± (OSM)</h3>
                        <p id="detail-address" class="detail-item">ğŸ“ ä½æ‰€: <span></span></p>
                        <p id="detail-hours" class="detail-item">ğŸ• å–¶æ¥­æ™‚é–“: <span></span></p>
                        <p id="detail-phone" class="detail-item">ğŸ“ é›»è©±: <span></span></p>
                        <p id="detail-website" class="detail-item">ğŸŒ Webã‚µã‚¤ãƒˆ: <a id="detail-website-link" href="#" target="_blank"></a></p>
                    </div>

                    <!-- Firebaseã®ãƒã‚¤ãƒªã‚¹ãƒˆæƒ…å ± -->
                    <div id="detail-my-info" class="detail-section" style="display: none;">
                        <h3>ãƒã‚¤ãƒªã‚¹ãƒˆè©•ä¾¡ã¨ãƒ¡ãƒ¢</h3>
                        <p id="detail-rating" class="detail-rating"></p>
                        <p id="detail-memo" class="detail-memo"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Detail Overlay -->

    <div id="app">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ (æ¤œç´¢çµæœã¨ãƒ•ã‚©ãƒ¼ãƒ ) -->
        <div id="sidebar">
            <div class="tabs">
                <div onclick="switchTab('search')" class="active">å‘¨è¾ºæ¤œç´¢</div>
                <div onclick="switchTab('mylist')">ãƒã‚¤ãƒªã‚¹ãƒˆ</div>
                <div onclick="switchTab('add')">åº—èˆ—ç™»éŒ²</div>
            </div>
            
            <div id="search-tab" class="tab-content">
                <div id="search-form">
                    <input type="text" id="searchTerm" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«ã‚„åº—åã‚’å…¥åŠ›..." value="restaurant">
                    <button onclick="searchNearby()">æ¤œç´¢</button>
                </div>
                <div id="nearbyList">
                    <p style="text-align: center; color: #999; padding: 2rem;">åœ°å›³ã‚’æ“ä½œã—ã¦ã€æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>

            <div id="mylist-tab" class="tab-content" style="display: none;">
                <p id="firebase-status" style="font-size: 0.9rem; margin-bottom: 1rem; color: #dc3545;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèªä¸­...</p>
                <div class="filter-chips">
                    <div class="chip active" data-category="all" onclick="filterMyList('all')">å…¨ã¦</div>
                    <div class="chip" data-category="Restaurant" onclick="filterMyList('Restaurant')">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</div>
                    <div class="chip" data-category="Cafe" onclick="filterMyList('Cafe')">ã‚«ãƒ•ã‚§</div>
                </div>
                <input type="text" id="myListSearch" oninput="searchMyRestaurants()" placeholder="ãƒã‚¤ãƒªã‚¹ãƒˆã‚’æ¤œç´¢...">
                <div id="restaurantList">
                    <!-- Firebaseã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å…¥ã‚‹ -->
                </div>
            </div>

            <div id="add-tab" class="tab-content" style="display: none;">
                <p>åœ°å›³ä¸Šã®è¿½åŠ ã—ãŸã„å ´æ‰€ã‚’**ã‚¯ãƒªãƒƒã‚¯**ã—ã¦ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                <form id="add-form" onsubmit="event.preventDefault(); saveRestaurant();">
                    <!-- (ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ã¯çœç•¥ - å¤‰æ›´ãªã—) -->
                    <div class="form-group">
                        <label for="coordinates">åº§æ¨™ (è‡ªå‹•å…¥åŠ›)</label>
                        <input type="text" id="coordinates" disabled>
                    </div>
                    <div class="form-group">
                        <label for="restaurantName">åº—èˆ—å *</label>
                        <input type="text" id="restaurantName" required>
                    </div>
                    <div class="form-group">
                        <label for="category">ã‚«ãƒ†ã‚´ãƒª *</label>
                        <select id="category" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="Restaurant">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</option>
                            <option value="Cafe">ã‚«ãƒ•ã‚§</option>
                            <option value="Bar">ãƒãƒ¼</option>
                            <option value="Fast Food">ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰</option>
                            <option value="Others">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è©•ä¾¡ (5æ®µéš)</label>
                        <div id="rating-group">
                            <input type="radio" id="star5" name="rating" value="5"><label for="star5">â˜…â˜…â˜…â˜…â˜… (5)</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4">â˜…â˜…â˜…â˜…â˜† (4)</label>
                            <input type="radio" id="star3" name="rating" value="3" checked><label for="star3">â˜…â˜…â˜…â˜†â˜† (3)</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2">â˜…â˜…â˜†â˜†â˜† (2)</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1">â˜…â˜†â˜†â˜†â˜† (1)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="priceRange">ä¾¡æ ¼å¸¯</label>
                        <select id="priceRange">
                            <option value="æœªè¨­å®š">æœªè¨­å®š</option>
                            <option value="ã€œÂ¥1,000">ã€œÂ¥1,000 (ä½)</option>
                            <option value="Â¥1,000ã€œÂ¥3,000">Â¥1,000ã€œÂ¥3,000 (ä¸­)</option>
                            <option value="Â¥3,000ã€œÂ¥8,000">Â¥3,000ã€œÂ¥8,000 (é«˜)</option>
                            <option value="Â¥8,000ã€œ">Â¥8,000ã€œ (é«˜ç´š)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">ãƒ¡ãƒ¢ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="add-button">ã“ã®å ´æ‰€ã‚’ãƒã‚¤ãƒªã‚¹ãƒˆã«ç™»éŒ²</button>
                    <div id="status" class="status" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script type="module">
        let map;
        let currentMarker = null; 
        let userLocationMarker = null; 
        let selectedLat = null;
        let selectedLng = null;
        window.currentTab = 'search';
        window.myListFilter = 'all';

        // Gemini APIè¨­å®š
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const API_KEY = ""; // CanvasãŒå®Ÿè¡Œæ™‚ã«æä¾›

        const categoryIcons = {
            'restaurant': 'ğŸ½ï¸',
            'cafe': 'â˜•',
            'fast_food': 'ğŸ”',
            'bar': 'ğŸ¸',
            'pub': 'ğŸº',
            'food_court': 'ğŸœ',
            'Restaurant': 'ğŸ½ï¸',
            'Cafe': 'â˜•',
            'Bar': 'ğŸ¸',
            'Fast Food': 'ğŸ”',
            'Others': 'ğŸ“Œ'
        };

        window.onload = function () {
            initializeMap();
            getCurrentLocation();
        }

        function initializeMap() {
            map = L.map('map').setView([35.681236, 139.767125], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            map.on('click', onMapClick);
        }

        function onMapClick(e) {
            if (currentTab === 'add') {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }

                currentMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("ç™»éŒ²äºˆå®šåœ°").openPopup();
                
                selectedLat = lat;
                selectedLng = lng;
                document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                map.setView([lat, lng], map.getZoom());
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                console.error('Geolocation is not supported by your browser');
                searchNearby();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 16);

                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.circleMarker([lat, lng], {
                        radius: 8,
                        color: 'blue',
                        fillColor: '#007bff',
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("ç¾åœ¨åœ°");
                    
                    searchNearby();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    searchNearby();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // æ¤œç´¢çµæœã‚’é£²é£Ÿåº—ã®ã¿ã«å³å¯†ã«çµã‚Šè¾¼ã‚€ (ä¿®æ­£æ¸ˆã¿)
        window.searchNearby = async function() {
            const searchTerm = document.getElementById('searchTerm').value.trim(); 
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            let query;

            if (searchTerm && searchTerm.toLowerCase() !== 'restaurant') {
                 const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                 
                 // æ¤œç´¢èªå¥ãŒã‚ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ORã‚¯ã‚¨ãƒªã§çµã‚Šè¾¼ã‚€
                 query = `
                    [out:json][timeout:25];
                    (
                        // 1. ä¸»è¦ãªé£²é£Ÿåº—ã‚¢ãƒ¡ãƒ‹ãƒ†ã‚£ã‚’æŒã¡ã€åç§°ã«éƒ¨åˆ†ä¸€è‡´
                        nwr[amenity~"restaurant|cafe|fast_food|bar|pub|food_court",i]["name"~".*${escapedSearchTerm}.*",i](${bbox});
                        
                        // 2. amenityãŒãªãã¦ã‚‚ã€ cuisineï¼ˆæ–™ç†ã‚¸ãƒ£ãƒ³ãƒ«ï¼‰ã‚’æŒã¡ã€åç§°ã«éƒ¨åˆ†ä¸€è‡´
                        nwr[cuisine]["name"~".*${escapedSearchTerm}.*",i](${bbox});
                    );
                    out center;
                 `;
            } else {
                // æ¤œç´¢èªå¥ãŒãªã„å ´åˆã¯ã€å³å¯†ã«é£²é£Ÿé–¢é€£ã®ã¿ã‚’æ¤œç´¢
                 query = `
                    [out:json][timeout:25];
                    (
                        nwr[amenity~"restaurant|cafe|fast_food|bar|pub|food_court",i](${bbox});
                    );
                    // nameã‚¿ã‚°ã‚’æŒã¤ã‚‚ã®ã®ã¿ã‚’å‡ºåŠ›
                    nwr[name];
                    out center;
                 `;
            }
            
            const apiUrl = "https://overpass-api.de/api/interpreter";

            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">OpenStreetMapã‹ã‚‰é£²é£Ÿåº—ã‚’æ¤œç´¢ä¸­...</p>';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `data=${encodeURIComponent(query)}`
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Overpass APIã‚¨ãƒ©ãƒ¼æœ¬æ–‡: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const restaurants = data.elements
                    .filter(el => el.tags && el.tags.name) 
                    .map(el => ({
                        name: el.tags.name,
                        category: el.tags.amenity || el.tags.cuisine || 'é£²é£Ÿåº—', 
                        cuisine: el.tags.cuisine || null,
                        address: el.tags['addr:full'] || el.tags['addr:street'] || el.tags.addr || null,
                        phone: el.tags.phone || null,
                        website: el.tags.website || el.tags.url || null,
                        opening_hours: el.tags.opening_hours || null,
                        latitude: el.lat || (el.center && el.center.lat),
                        longitude: el.lon || (el.center && el.center.lon),
                        source: 'osm'
                    }));
                    
                displayNearbyRestaurants(restaurants);
                
            } catch (error) {
                console.error("Overpass APIã‚¨ãƒ©ãƒ¼:", error);
                nearbyList.innerHTML = '<p class="status error">æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚OpenStreetMapã®ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ããªã„ã‹ã€ã‚¯ã‚¨ãƒªãŒç„¡åŠ¹ã§ã™ã€‚</p>';
            }
        }

        // æ¤œç´¢çµæœã‚’ãƒªã‚¹ãƒˆã¨ãƒãƒƒãƒ—ã«è¡¨ç¤º (å¤‰æ›´ãªã—)
        function displayNearbyRestaurants(restaurants) {
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && 
                    layer !== currentMarker && 
                    layer !== userLocationMarker &&
                    !layer.options.isMyRestaurant) {
                    map.removeLayer(layer);
                }
            });
            
            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '';
            
            if (restaurants.length === 0) {
                nearbyList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            restaurants.forEach((data) => {
                const categoryKey = data.category.toLowerCase();
                const icon = categoryIcons[categoryKey] || 'ğŸ´';
                
                const customIcon = L.divIcon({
                    html: `<div style="font-size: 24px;">${icon}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30]
                });
                
                const marker = L.marker([data.latitude, data.longitude], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`<strong>${data.name}</strong><br><small>å‡ºå…¸: OSM</small>`);
                
                const categoryName = {
                    'restaurant': 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'cafe': 'ã‚«ãƒ•ã‚§', 'fast_food': 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', 
                    'bar': 'ãƒãƒ¼', 'pub': 'ãƒ‘ãƒ–', 'food_court': 'ãƒ•ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒˆ'
                }[categoryKey] || data.category;
                
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${icon} ${data.name}
                        <span class="category-badge">${categoryName}</span>
                    </h4>
                    ${data.cuisine ? `<p>æ–™ç†: ${data.cuisine}</p>` : ''}
                    ${data.address ? `<p>ğŸ“ ${data.address || 'ä½æ‰€æƒ…å ±ãªã—'}</p>` : ''}
                `;
                item.onclick = () => {
                    openDetailOverlay(data);
                    map.setView([data.latitude, data.longitude], 17);
                    marker.openPopup();
                };
                nearbyList.appendChild(item);
            });
        }
        
        // --- Gemini APIã«ã‚ˆã‚‹å¤–éƒ¨æƒ…å ±å–å¾—æ©Ÿèƒ½ ---

        async function fetchGeminiDetails(restaurantName) {
            const geminiInfoDiv = document.getElementById('detail-gemini-info');
            geminiInfoDiv.innerHTML = '<div class="detail-section"><p class="status success" style="background-color: #e9f5ff; color: #007bff; margin-bottom: 0;">âœ¨ å¤–éƒ¨Webæƒ…å ±æ¤œç´¢ä¸­...</p></div>';

            const systemPrompt = `ã‚ãªãŸã¯ä¸–ç•Œçš„ãªæƒ…å ±åé›†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æä¾›ã•ã‚ŒãŸãƒ¬ã‚¹ãƒˆãƒ©ãƒ³åã«åŸºã¥ã„ã¦Googleæ¤œç´¢ã‚’è¡Œã„ã€ä»¥ä¸‹ã®JSONæ§‹é€ ã«å³å¯†ã«å¾“ã£ã¦æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
            - 'summary': ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ç°¡å˜ãªæ¦‚è¦ã€ç‰¹å¾´ã€ã¾ãŸã¯è©•åˆ¤ã‚’æ—¥æœ¬èªã§1ã€œ2æ–‡ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚æƒ…å ±ãŒãªã„å ´åˆã¯ã€Œæ¤œç´¢æƒ…å ±ãªã—ã€ã¨ã—ã¦ãã ã•ã„ã€‚
            - 'website': å…¬å¼ã¾ãŸã¯ä¿¡é ¼ã§ãã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆã®URLãŒã‚ã‚Œã°æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
            - 'reviews_snippet': é–¢é€£ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æŠœç²‹ã‚„è©•ä¾¡ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼ˆã‚ã‚Œã°ï¼‰ã‚’1ã¤æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚`;

            const userQuery = `${restaurantName} ã®ç‰¹å¾´ã¨è©•åˆ¤ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "summary": { "type": "STRING" },
                            "website": { "type": "STRING" },
                            "reviews_snippet": { "type": "STRING" }
                        }
                    }
                }
            };

            try {
                const response = await fetch(GEMINI_API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Request Failed with status ${response.status}`);

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text.trim();
                    const parsedJson = JSON.parse(jsonText);
                    
                    // UIã«è¡¨ç¤º
                    geminiInfoDiv.innerHTML = `
                        <div class="detail-section">
                            <h3>Webæ¤œç´¢ã«ã‚ˆã‚‹æƒ…å ± (Gemini)</h3>
                            <p class="detail-item"><strong>è¦ç´„:</strong> <span>${parsedJson.summary || 'æ¤œç´¢æƒ…å ±ãªã—'}</span></p>
                            ${parsedJson.reviews_snippet ? `<p class="detail-item"><strong>ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠœç²‹:</strong> <em>"${parsedJson.reviews_snippet}"</em></p>` : ''}
                            ${parsedJson.website ? `<p class="detail-item"><strong>Webã‚µã‚¤ãƒˆ:</strong> <a href="${parsedJson.website}" target="_blank">${parsedJson.website.replace(/https?:\/\//, '').split('/')[0]}</a></p>` : ''}
                        </div>
                    `;
                } else {
                     geminiInfoDiv.innerHTML = '<div class="detail-section"><p class="status error">å¤–éƒ¨æƒ…å ±æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p></div>';
                }

            } catch (e) {
                console.error("Gemini APIã‚¨ãƒ©ãƒ¼:", e);
                geminiInfoDiv.innerHTML = '<div class="detail-section"><p class="status error">å¤–éƒ¨æƒ…å ±æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p></div>';
            }
        }


        // è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º (Gemini APIå‘¼ã³å‡ºã—ã‚’è¿½åŠ )
        window.openDetailOverlay = function(restaurantData) {
            const overlay = document.getElementById('restaurant-detail-overlay');
            const websiteLinkEl = document.getElementById('detail-website-link');
            const websiteContainerEl = document.getElementById('detail-website');
            
            // ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆ
            document.getElementById('detail-name').textContent = restaurantData.name;
            document.getElementById('detail-source').textContent = (restaurantData.source === 'firebase') ? 'å‡ºå…¸: ãƒã‚¤ãƒªã‚¹ãƒˆ (æ‰‹å‹•ç™»éŒ²)' : 'å‡ºå…¸: OpenStreetMap';
            document.getElementById('detail-category').textContent = restaurantData.category || 'æœªè¨­å®š';
            document.getElementById('detail-cuisine').textContent = restaurantData.cuisine ? `æ–™ç†: ${restaurantData.cuisine}` : '';
            document.getElementById('detail-cuisine').style.display = restaurantData.cuisine ? 'inline-block' : 'none';

            // OSM/å…±é€šæƒ…å ±
            document.getElementById('detail-address').querySelector('span').textContent = restaurantData.address || 'æƒ…å ±ãªã—';
            document.getElementById('detail-hours').querySelector('span').textContent = restaurantData.opening_hours || 'æƒ…å ±ãªã—';
            document.getElementById('detail-phone').querySelector('span').textContent = restaurantData.phone || 'æƒ…å ±ãªã—';
            
            // OSM Webã‚µã‚¤ãƒˆ
            if (restaurantData.website) {
                websiteLinkEl.href = (restaurantData.website.startsWith('http')) ? restaurantData.website : `http://${restaurantData.website}`;
                websiteLinkEl.textContent = websiteLinkEl.href.replace(/https?:\/\//, '').split('/')[0];
                websiteContainerEl.style.display = 'block';
            } else {
                websiteContainerEl.style.display = 'none';
            }

            // Firebase (ãƒã‚¤ãƒªã‚¹ãƒˆ) å°‚ç”¨æƒ…å ±
            const myInfoEl = document.getElementById('detail-my-info');
            const priceEl = document.getElementById('detail-price');
            if (restaurantData.source === 'firebase') {
                myInfoEl.style.display = 'block';
                priceEl.textContent = restaurantData.priceRange || 'æœªè¨­å®š';
                priceEl.style.display = 'inline-block';
                const rating = restaurantData.rating || 0;
                const stars = 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
                document.getElementById('detail-rating').innerHTML = `<span style="font-size: 1.5rem;">${stars}</span> (${rating}.0)`;
                document.getElementById('detail-memo').textContent = restaurantData.description || 'ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“';
            } else {
                myInfoEl.style.display = 'none';
                priceEl.style.display = 'none';
                document.getElementById('detail-price').textContent = '';
            }
            
            // --- ã“ã“ã§Gemini APIã‚’å‘¼ã³å‡ºã—ã€å¤–éƒ¨æƒ…å ±ã‚’å–å¾— ---
            fetchGeminiDetails(restaurantData.name);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            overlay.classList.add('open');
        };

        window.closeDetailOverlay = function() {
            document.getElementById('restaurant-detail-overlay').classList.remove('open');
        };

        // --- Firebase/ãƒã‚¤ãƒªã‚¹ãƒˆé–¢é€£é–¢æ•° (DBæ¥ç¶šãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ) ---

        window.saveRestaurant = async function() {
            if (!window.isFirebaseReady || !db) {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: Firebaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                return;
            }
            // (ä»¥ä¸‹ã€ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            const name = document.getElementById('restaurantName').value;
            const category = document.getElementById('category').value;
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            const rating = ratingEl ? parseInt(ratingEl.value) : 3;
            const priceRange = document.getElementById('priceRange').value;
            const description = document.getElementById('description').value;
            
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'none';

            if (!name || !category || !selectedLat || !selectedLng) {
                statusDiv.textContent = 'åº—åã€ã‚«ãƒ†ã‚´ãƒªã€ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                return;
            }
            
            const newRestaurant = {
                name: name,
                category: category,
                rating: rating,
                priceRange: priceRange,
                description: description,
                latitude: selectedLat,
                longitude: selectedLng,
                createdAt: new Date(),
                source: 'firebase', 
            };

            try {
                await addDoc(collection(db, "restaurants"), newRestaurant);
                
                statusDiv.textContent = 'ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼';
                statusDiv.className = 'status success';
                statusDiv.style.display = 'block';
                document.getElementById('add-form').reset();
                document.getElementById('coordinates').value = '';
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = null;
                selectedLat = null;
                selectedLng = null;
                openDetailOverlay({ ...newRestaurant });

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);

            } catch (e) {
                console.error("Firebaseã¸ã®æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                statusDiv.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
            }
        };

        window.fetchRestaurants = async function() {
            const listDiv = document.getElementById('restaurantList');
            if (!window.isFirebaseReady || !db) {
                 listDiv.innerHTML = '<p class="status error">Firebaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒã‚¤ãƒªã‚¹ãƒˆã¯ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚</p>';
                 return;
            }
            // (ä»¥ä¸‹ã€ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            listDiv.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">ãƒã‚¤ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const q = query(collection(db, "restaurants"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                window.allRestaurants = [];
                querySnapshot.forEach((doc) => {
                    window.allRestaurants.push({ id: doc.id, source: 'firebase', ...doc.data() });
                });
                displayMyRestaurants(window.allRestaurants);
            } catch (error) {
                console.error("Firebaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                listDiv.innerHTML = '<p class="status error">ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        };

        // (displayMyRestaurants, filterMyList, searchMyRestaurantsã¯å¤‰æ›´ãªã—)
        window.displayMyRestaurants = function(restaurants) {
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '';
            
            let filtered = restaurants;
            
            if (window.myListFilter !== 'all') {
                filtered = filtered.filter(r => r.category === window.myListFilter);
            }
            
            const searchInput = document.getElementById('myListSearch').value.toLowerCase();
            if (searchInput) {
                filtered = filtered.filter(r => 
                    r.name.toLowerCase().includes(searchInput) ||
                    (r.description && r.description.toLowerCase().includes(searchInput))
                );
            }

            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">æ¤œç´¢æ¡ä»¶ã«åˆã†åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            filtered.forEach((data) => {
                const stars = 'â˜…'.repeat(data.rating) + 'â˜†'.repeat(5 - data.rating);
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${categoryIcons[data.category] || 'ğŸ“Œ'} ${data.name}
                        <span class="category-badge">${data.category}</span>
                    </h4>
                    <p class="stars">${stars}</p>
                    <p class="price-range">${data.priceRange || 'æœªè¨­å®š'}</p>
                    <p>ãƒ¡ãƒ¢: ${data.description ? data.description.substring(0, 40) + (data.description.length > 40 ? '...' : '') : 'ãƒ¡ãƒ¢ãªã—'}</p>
                `;
                
                item.onclick = () => {
                    openDetailOverlay(data);
                    if (data.latitude && data.longitude) {
                         map.setView([data.latitude, data.longitude], 17);
                    }
                };
                listDiv.appendChild(item);
            });
        };

        window.filterMyList = function(category) {
            window.myListFilter = category;
            
            document.querySelectorAll('#mylist-tab .filter-chips .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`#mylist-tab .filter-chips .chip[data-category="${category}"]`).classList.add('active');
            
            displayMyRestaurants(window.allRestaurants);
        };
        
        window.searchMyRestaurants = function() {
             displayMyRestaurants(window.allRestaurants);
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            document.querySelectorAll('.tabs > div').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tabs > div[onclick="switchTab('${tabName}')"]`).classList.add('active');

            window.currentTab = tabName;
            
            if (tabName === 'mylist') {
                if (window.db) {
                    fetchRestaurants();
                } else {
                    document.getElementById('restaurantList').innerHTML = '<p class="status error">Firebaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒã‚¤ãƒªã‚¹ãƒˆã¯ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚</p>';
                }
            } else if (tabName === 'add') {
                 if (currentMarker) map.removeLayer(currentMarker);
                 document.getElementById('coordinates').value = '';
            }
        };

    </script>
</body>
</html>
