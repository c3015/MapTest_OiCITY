<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食店マップ</title>
    <!-- Firebase SDK (必須) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, getDocs, collection, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreのデバッグログを有効化
        setLogLevel('debug');

        // グローバル変数として定義
        let app;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.allRestaurants = []; 
        window.isFirebaseReady = false; // Firebaseの準備状態

        // Firebase初期化と認証処理
        const initFirebase = async () => {
            let firebaseConfig = null;
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                }
                
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    // Firebase初期化エラーが発生した場合のフラグ設定
                    console.warn("Firebase初期化失敗: projectIdが見つかりません。マイリスト機能は利用できません。");
                    document.getElementById('firebase-status').textContent = '⚠️ マイリスト機能は利用できません (DB未設定)';
                    return; 
                }
                
                app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // 認証ロジック
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                // 認証状態の変更を監視
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        window.userId = crypto.randomUUID();
                    }
                    window.isFirebaseReady = true;
                    document.getElementById('firebase-status').textContent = '✅ マイリスト機能利用可能';
                    if (window.currentTab === 'mylist') {
                        window.fetchRestaurants();
                    }
                });

            } catch (e) {
                console.error("Firebase初期化エラー:", e);
                document.getElementById('firebase-status').textContent = `❌ Firebase接続エラー: ${e.message}`;
            }
        };

        // アプリ起動時に初期化
        initFirebase();
    </script>

    <!-- Leaflet CSSとJS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* (前回のCSSとほぼ同じですが、詳細モーダルを一部更新) */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        #app {
            display: flex;
            height: 100vh;
            max-width: 100vw;
        }

        #map-container {
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #sidebar {
            width: 380px;
            max-width: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
        }

        @media (max-width: 768px) {
            #app {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: 50%;
            }
            #map-container {
                height: 50%;
            }
        }
        
        .tabs {
            display: flex;
            background-color: #e9ecef;
            border-bottom: 2px solid #ced4da;
        }
        .tabs > div {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: background-color 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tabs > div.active {
            color: #007bff;
            background-color: white;
            border-bottom-color: #007bff;
        }

        .tab-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        #search-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        #search-form input, #search-form button {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        #search-form button {
            background-color: #007bff;
        }

        .restaurant-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .restaurant-item h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        .category-badge {
            background-color: #ff6b6b;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* 詳細オーバーレイのスタイル */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-overlay.open {
            display: flex;
            opacity: 1;
        }

        .detail-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .detail-info {
            padding: 1.5rem;
        }

        .detail-section {
            padding: 1rem 0;
            border-top: 1px solid #e0e0e0;
        }
        
        .detail-section h3 {
            font-size: 1rem;
            color: #999;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }
        
        .detail-item {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

    </style>
</head>
<body>

    <!-- 飲食店詳細オーバーレイ (モーダル) -->
    <div id="restaurant-detail-overlay" class="detail-overlay">
        <div class="detail-modal">
            <button class="close-btn" onclick="closeDetailOverlay()">✖️</button>
            <div class="detail-content">
                <div id="detail-image-container" class="detail-image-container">
                    <div id="detail-image-placeholder" class="detail-image-placeholder">
                        🍽️ 店舗イメージ
                    </div>
                </div>
                <div class="detail-info">
                    <h2 id="detail-name" class="detail-name"></h2>
                    <p class="detail-source" id="detail-source"></p>
                    <div class="detail-badges">
                        <span id="detail-category" class="badge"></span>
                        <span id="detail-price" class="badge price-badge"></span>
                        <span id="detail-cuisine" class="badge"></span>
                    </div>
                    
                    <!-- 外部情報表示エリア (Gemini APIの結果) -->
                    <div id="detail-gemini-info">
                        <!-- 検索結果がここに入ります -->
                    </div>

                    <!-- OpenStreetMapの基本情報 -->
                    <div class="detail-section">
                        <h3>基本情報 (OSM)</h3>
                        <p id="detail-address" class="detail-item">📍 住所: <span></span></p>
                        <p id="detail-hours" class="detail-item">🕐 営業時間: <span></span></p>
                        <p id="detail-phone" class="detail-item">📞 電話: <span></span></p>
                        <p id="detail-website" class="detail-item">🌐 Webサイト: <a id="detail-website-link" href="#" target="_blank"></a></p>
                    </div>

                    <!-- Firebaseのマイリスト情報 -->
                    <div id="detail-my-info" class="detail-section" style="display: none;">
                        <h3>マイリスト評価とメモ</h3>
                        <p id="detail-rating" class="detail-rating"></p>
                        <p id="detail-memo" class="detail-memo"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Detail Overlay -->

    <div id="app">
        <!-- サイドバー (検索結果とフォーム) -->
        <div id="sidebar">
            <div class="tabs">
                <div onclick="switchTab('search')" class="active">周辺検索</div>
                <div onclick="switchTab('mylist')">マイリスト</div>
                <div onclick="switchTab('add')">店舗登録</div>
            </div>
            
            <div id="search-tab" class="tab-content">
                <div id="search-form">
                    <input type="text" id="searchTerm" placeholder="ジャンルや店名を入力..." value="restaurant">
                    <button onclick="searchNearby()">検索</button>
                </div>
                <div id="nearbyList">
                    <p style="text-align: center; color: #999; padding: 2rem;">地図を操作して、検索ボタンを押してください。</p>
                </div>
            </div>

            <div id="mylist-tab" class="tab-content" style="display: none;">
                <p id="firebase-status" style="font-size: 0.9rem; margin-bottom: 1rem; color: #dc3545;">⚠️ データベース接続確認中...</p>
                <div class="filter-chips">
                    <div class="chip active" data-category="all" onclick="filterMyList('all')">全て</div>
                    <div class="chip" data-category="Restaurant" onclick="filterMyList('Restaurant')">レストラン</div>
                    <div class="chip" data-category="Cafe" onclick="filterMyList('Cafe')">カフェ</div>
                </div>
                <input type="text" id="myListSearch" oninput="searchMyRestaurants()" placeholder="マイリストを検索...">
                <div id="restaurantList">
                    <!-- Firebaseから読み込まれたデータがここに入る -->
                </div>
            </div>

            <div id="add-tab" class="tab-content" style="display: none;">
                <p>地図上の追加したい場所を**クリック**して位置を設定してください。</p>
                <form id="add-form" onsubmit="event.preventDefault(); saveRestaurant();">
                    <!-- (フォーム内容は省略 - 変更なし) -->
                    <div class="form-group">
                        <label for="coordinates">座標 (自動入力)</label>
                        <input type="text" id="coordinates" disabled>
                    </div>
                    <div class="form-group">
                        <label for="restaurantName">店舗名 *</label>
                        <input type="text" id="restaurantName" required>
                    </div>
                    <div class="form-group">
                        <label for="category">カテゴリ *</label>
                        <select id="category" required>
                            <option value="">選択してください</option>
                            <option value="Restaurant">レストラン</option>
                            <option value="Cafe">カフェ</option>
                            <option value="Bar">バー</option>
                            <option value="Fast Food">ファストフード</option>
                            <option value="Others">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>評価 (5段階)</label>
                        <div id="rating-group">
                            <input type="radio" id="star5" name="rating" value="5"><label for="star5">★★★★★ (5)</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4">★★★★☆ (4)</label>
                            <input type="radio" id="star3" name="rating" value="3" checked><label for="star3">★★★☆☆ (3)</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2">★★☆☆☆ (2)</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1">★☆☆☆☆ (1)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="priceRange">価格帯</label>
                        <select id="priceRange">
                            <option value="未設定">未設定</option>
                            <option value="〜¥1,000">〜¥1,000 (低)</option>
                            <option value="¥1,000〜¥3,000">¥1,000〜¥3,000 (中)</option>
                            <option value="¥3,000〜¥8,000">¥3,000〜¥8,000 (高)</option>
                            <option value="¥8,000〜">¥8,000〜 (高級)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">メモ・レビュー</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="add-button">この場所をマイリストに登録</button>
                    <div id="status" class="status" style="display: none;"></div>
                </form>
            </div>
        </div>

        <!-- マップ表示エリア -->
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script type="module">
        let map;
        let currentMarker = null; 
        let userLocationMarker = null; 
        let selectedLat = null;
        let selectedLng = null;
        window.currentTab = 'search';
        window.myListFilter = 'all';

        // Gemini API設定
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const API_KEY = ""; // Canvasが実行時に提供

        const categoryIcons = {
            'restaurant': '🍽️',
            'cafe': '☕',
            'fast_food': '🍔',
            'bar': '🍸',
            'pub': '🍺',
            'food_court': '🍜',
            'Restaurant': '🍽️',
            'Cafe': '☕',
            'Bar': '🍸',
            'Fast Food': '🍔',
            'Others': '📌'
        };

        window.onload = function () {
            initializeMap();
            getCurrentLocation();
        }

        function initializeMap() {
            map = L.map('map').setView([35.681236, 139.767125], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            map.on('click', onMapClick);
        }

        function onMapClick(e) {
            if (currentTab === 'add') {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }

                currentMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("登録予定地").openPopup();
                
                selectedLat = lat;
                selectedLng = lng;
                document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                map.setView([lat, lng], map.getZoom());
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                console.error('Geolocation is not supported by your browser');
                searchNearby();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 16);

                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.circleMarker([lat, lng], {
                        radius: 8,
                        color: 'blue',
                        fillColor: '#007bff',
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("現在地");
                    
                    searchNearby();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    searchNearby();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        // 検索結果を飲食店のみに厳密に絞り込む (修正済み)
        window.searchNearby = async function() {
            const searchTerm = document.getElementById('searchTerm').value.trim(); 
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            let query;

            if (searchTerm && searchTerm.toLowerCase() !== 'restaurant') {
                 const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                 
                 // 検索語句がある場合は、以下のORクエリで絞り込む
                 query = `
                    [out:json][timeout:25];
                    (
                        // 1. 主要な飲食店アメニティを持ち、名称に部分一致
                        nwr[amenity~"restaurant|cafe|fast_food|bar|pub|food_court",i]["name"~".*${escapedSearchTerm}.*",i](${bbox});
                        
                        // 2. amenityがなくても、 cuisine（料理ジャンル）を持ち、名称に部分一致
                        nwr[cuisine]["name"~".*${escapedSearchTerm}.*",i](${bbox});
                    );
                    out center;
                 `;
            } else {
                // 検索語句がない場合は、厳密に飲食関連のみを検索
                 query = `
                    [out:json][timeout:25];
                    (
                        nwr[amenity~"restaurant|cafe|fast_food|bar|pub|food_court",i](${bbox});
                    );
                    // nameタグを持つもののみを出力
                    nwr[name];
                    out center;
                 `;
            }
            
            const apiUrl = "https://overpass-api.de/api/interpreter";

            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">OpenStreetMapから飲食店を検索中...</p>';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `data=${encodeURIComponent(query)}`
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Overpass APIエラー本文: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const restaurants = data.elements
                    .filter(el => el.tags && el.tags.name) 
                    .map(el => ({
                        name: el.tags.name,
                        category: el.tags.amenity || el.tags.cuisine || '飲食店', 
                        cuisine: el.tags.cuisine || null,
                        address: el.tags['addr:full'] || el.tags['addr:street'] || el.tags.addr || null,
                        phone: el.tags.phone || null,
                        website: el.tags.website || el.tags.url || null,
                        opening_hours: el.tags.opening_hours || null,
                        latitude: el.lat || (el.center && el.center.lat),
                        longitude: el.lon || (el.center && el.center.lon),
                        source: 'osm'
                    }));
                    
                displayNearbyRestaurants(restaurants);
                
            } catch (error) {
                console.error("Overpass APIエラー:", error);
                nearbyList.innerHTML = '<p class="status error">検索に失敗しました。OpenStreetMapのデータが利用できないか、クエリが無効です。</p>';
            }
        }

        // 検索結果をリストとマップに表示 (変更なし)
        function displayNearbyRestaurants(restaurants) {
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && 
                    layer !== currentMarker && 
                    layer !== userLocationMarker &&
                    !layer.options.isMyRestaurant) {
                    map.removeLayer(layer);
                }
            });
            
            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = '';
            
            if (restaurants.length === 0) {
                nearbyList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">検索結果がありません</p>';
                return;
            }
            
            restaurants.forEach((data) => {
                const categoryKey = data.category.toLowerCase();
                const icon = categoryIcons[categoryKey] || '🍴';
                
                const customIcon = L.divIcon({
                    html: `<div style="font-size: 24px;">${icon}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30]
                });
                
                const marker = L.marker([data.latitude, data.longitude], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`<strong>${data.name}</strong><br><small>出典: OSM</small>`);
                
                const categoryName = {
                    'restaurant': 'レストラン', 'cafe': 'カフェ', 'fast_food': 'ファストフード', 
                    'bar': 'バー', 'pub': 'パブ', 'food_court': 'フードコート'
                }[categoryKey] || data.category;
                
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${icon} ${data.name}
                        <span class="category-badge">${categoryName}</span>
                    </h4>
                    ${data.cuisine ? `<p>料理: ${data.cuisine}</p>` : ''}
                    ${data.address ? `<p>📍 ${data.address || '住所情報なし'}</p>` : ''}
                `;
                item.onclick = () => {
                    openDetailOverlay(data);
                    map.setView([data.latitude, data.longitude], 17);
                    marker.openPopup();
                };
                nearbyList.appendChild(item);
            });
        }
        
        // --- Gemini APIによる外部情報取得機能 ---

        async function fetchGeminiDetails(restaurantName) {
            const geminiInfoDiv = document.getElementById('detail-gemini-info');
            geminiInfoDiv.innerHTML = '<div class="detail-section"><p class="status success" style="background-color: #e9f5ff; color: #007bff; margin-bottom: 0;">✨ 外部Web情報検索中...</p></div>';

            const systemPrompt = `あなたは世界的な情報収集アシスタントです。提供されたレストラン名に基づいてGoogle検索を行い、以下のJSON構造に厳密に従って情報を抽出してください。
            - 'summary': レストランの簡単な概要、特徴、または評判を日本語で1〜2文で要約してください。情報がない場合は「検索情報なし」としてください。
            - 'website': 公式または信頼できるレビューサイトのURLがあれば抽出してください。
            - 'reviews_snippet': 関連するレビューの抜粋や評価スニペット（あれば）を1つ抽出してください。`;

            const userQuery = `${restaurantName} の特徴と評判を教えてください。`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "summary": { "type": "STRING" },
                            "website": { "type": "STRING" },
                            "reviews_snippet": { "type": "STRING" }
                        }
                    }
                }
            };

            try {
                const response = await fetch(GEMINI_API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Request Failed with status ${response.status}`);

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text.trim();
                    const parsedJson = JSON.parse(jsonText);
                    
                    // UIに表示
                    geminiInfoDiv.innerHTML = `
                        <div class="detail-section">
                            <h3>Web検索による情報 (Gemini)</h3>
                            <p class="detail-item"><strong>要約:</strong> <span>${parsedJson.summary || '検索情報なし'}</span></p>
                            ${parsedJson.reviews_snippet ? `<p class="detail-item"><strong>レビュー抜粋:</strong> <em>"${parsedJson.reviews_snippet}"</em></p>` : ''}
                            ${parsedJson.website ? `<p class="detail-item"><strong>Webサイト:</strong> <a href="${parsedJson.website}" target="_blank">${parsedJson.website.replace(/https?:\/\//, '').split('/')[0]}</a></p>` : ''}
                        </div>
                    `;
                } else {
                     geminiInfoDiv.innerHTML = '<div class="detail-section"><p class="status error">外部情報検索に失敗しました。</p></div>';
                }

            } catch (e) {
                console.error("Gemini APIエラー:", e);
                geminiInfoDiv.innerHTML = '<div class="detail-section"><p class="status error">外部情報検索中にエラーが発生しました。</p></div>';
            }
        }


        // 詳細オーバーレイ表示 (Gemini API呼び出しを追加)
        window.openDetailOverlay = function(restaurantData) {
            const overlay = document.getElementById('restaurant-detail-overlay');
            const websiteLinkEl = document.getElementById('detail-website-link');
            const websiteContainerEl = document.getElementById('detail-website');
            
            // データのセット
            document.getElementById('detail-name').textContent = restaurantData.name;
            document.getElementById('detail-source').textContent = (restaurantData.source === 'firebase') ? '出典: マイリスト (手動登録)' : '出典: OpenStreetMap';
            document.getElementById('detail-category').textContent = restaurantData.category || '未設定';
            document.getElementById('detail-cuisine').textContent = restaurantData.cuisine ? `料理: ${restaurantData.cuisine}` : '';
            document.getElementById('detail-cuisine').style.display = restaurantData.cuisine ? 'inline-block' : 'none';

            // OSM/共通情報
            document.getElementById('detail-address').querySelector('span').textContent = restaurantData.address || '情報なし';
            document.getElementById('detail-hours').querySelector('span').textContent = restaurantData.opening_hours || '情報なし';
            document.getElementById('detail-phone').querySelector('span').textContent = restaurantData.phone || '情報なし';
            
            // OSM Webサイト
            if (restaurantData.website) {
                websiteLinkEl.href = (restaurantData.website.startsWith('http')) ? restaurantData.website : `http://${restaurantData.website}`;
                websiteLinkEl.textContent = websiteLinkEl.href.replace(/https?:\/\//, '').split('/')[0];
                websiteContainerEl.style.display = 'block';
            } else {
                websiteContainerEl.style.display = 'none';
            }

            // Firebase (マイリスト) 専用情報
            const myInfoEl = document.getElementById('detail-my-info');
            const priceEl = document.getElementById('detail-price');
            if (restaurantData.source === 'firebase') {
                myInfoEl.style.display = 'block';
                priceEl.textContent = restaurantData.priceRange || '未設定';
                priceEl.style.display = 'inline-block';
                const rating = restaurantData.rating || 0;
                const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
                document.getElementById('detail-rating').innerHTML = `<span style="font-size: 1.5rem;">${stars}</span> (${rating}.0)`;
                document.getElementById('detail-memo').textContent = restaurantData.description || 'メモはありません';
            } else {
                myInfoEl.style.display = 'none';
                priceEl.style.display = 'none';
                document.getElementById('detail-price').textContent = '';
            }
            
            // --- ここでGemini APIを呼び出し、外部情報を取得 ---
            fetchGeminiDetails(restaurantData.name);

            // モーダルを表示
            overlay.classList.add('open');
        };

        window.closeDetailOverlay = function() {
            document.getElementById('restaurant-detail-overlay').classList.remove('open');
        };

        // --- Firebase/マイリスト関連関数 (DB接続チェックを追加) ---

        window.saveRestaurant = async function() {
            if (!window.isFirebaseReady || !db) {
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = 'エラー: Firebaseデータベースが利用できません。';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                return;
            }
            // (以下、保存ロジックは変更なし)
            const name = document.getElementById('restaurantName').value;
            const category = document.getElementById('category').value;
            const ratingEl = document.querySelector('input[name="rating"]:checked');
            const rating = ratingEl ? parseInt(ratingEl.value) : 3;
            const priceRange = document.getElementById('priceRange').value;
            const description = document.getElementById('description').value;
            
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'none';

            if (!name || !category || !selectedLat || !selectedLng) {
                statusDiv.textContent = '店名、カテゴリ、位置を選択してください。';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
                return;
            }
            
            const newRestaurant = {
                name: name,
                category: category,
                rating: rating,
                priceRange: priceRange,
                description: description,
                latitude: selectedLat,
                longitude: selectedLng,
                createdAt: new Date(),
                source: 'firebase', 
            };

            try {
                await addDoc(collection(db, "restaurants"), newRestaurant);
                
                statusDiv.textContent = '保存に成功しました！';
                statusDiv.className = 'status success';
                statusDiv.style.display = 'block';
                document.getElementById('add-form').reset();
                document.getElementById('coordinates').value = '';
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = null;
                selectedLat = null;
                selectedLng = null;
                openDetailOverlay({ ...newRestaurant });

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);

            } catch (e) {
                console.error("Firebaseへの書き込みエラー:", e);
                statusDiv.textContent = '保存に失敗しました。コンソールを確認してください。';
                statusDiv.className = 'status error';
                statusDiv.style.display = 'block';
            }
        };

        window.fetchRestaurants = async function() {
            const listDiv = document.getElementById('restaurantList');
            if (!window.isFirebaseReady || !db) {
                 listDiv.innerHTML = '<p class="status error">Firebaseデータベースが利用できないため、マイリストはロードできません。</p>';
                 return;
            }
            // (以下、データ取得ロジックは変更なし)
            listDiv.innerHTML = '<p style="text-align: center; color: #007bff; padding: 2rem;">マイリストを読み込み中...</p>';

            try {
                const q = query(collection(db, "restaurants"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                window.allRestaurants = [];
                querySnapshot.forEach((doc) => {
                    window.allRestaurants.push({ id: doc.id, source: 'firebase', ...doc.data() });
                });
                displayMyRestaurants(window.allRestaurants);
            } catch (error) {
                console.error("Firebaseからのデータ取得エラー:", error);
                listDiv.innerHTML = '<p class="status error">リストの読み込みに失敗しました。</p>';
            }
        };

        // (displayMyRestaurants, filterMyList, searchMyRestaurantsは変更なし)
        window.displayMyRestaurants = function(restaurants) {
            const listDiv = document.getElementById('restaurantList');
            listDiv.innerHTML = '';
            
            let filtered = restaurants;
            
            if (window.myListFilter !== 'all') {
                filtered = filtered.filter(r => r.category === window.myListFilter);
            }
            
            const searchInput = document.getElementById('myListSearch').value.toLowerCase();
            if (searchInput) {
                filtered = filtered.filter(r => 
                    r.name.toLowerCase().includes(searchInput) ||
                    (r.description && r.description.toLowerCase().includes(searchInput))
                );
            }

            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">検索条件に合う店舗がありません</p>';
                return;
            }
            
            filtered.forEach((data) => {
                const stars = '★'.repeat(data.rating) + '☆'.repeat(5 - data.rating);
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.innerHTML = `
                    <h4>
                        ${categoryIcons[data.category] || '📌'} ${data.name}
                        <span class="category-badge">${data.category}</span>
                    </h4>
                    <p class="stars">${stars}</p>
                    <p class="price-range">${data.priceRange || '未設定'}</p>
                    <p>メモ: ${data.description ? data.description.substring(0, 40) + (data.description.length > 40 ? '...' : '') : 'メモなし'}</p>
                `;
                
                item.onclick = () => {
                    openDetailOverlay(data);
                    if (data.latitude && data.longitude) {
                         map.setView([data.latitude, data.longitude], 17);
                    }
                };
                listDiv.appendChild(item);
            });
        };

        window.filterMyList = function(category) {
            window.myListFilter = category;
            
            document.querySelectorAll('#mylist-tab .filter-chips .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`#mylist-tab .filter-chips .chip[data-category="${category}"]`).classList.add('active');
            
            displayMyRestaurants(window.allRestaurants);
        };
        
        window.searchMyRestaurants = function() {
             displayMyRestaurants(window.allRestaurants);
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            document.querySelectorAll('.tabs > div').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tabs > div[onclick="switchTab('${tabName}')"]`).classList.add('active');

            window.currentTab = tabName;
            
            if (tabName === 'mylist') {
                if (window.db) {
                    fetchRestaurants();
                } else {
                    document.getElementById('restaurantList').innerHTML = '<p class="status error">Firebaseデータベースが利用できないため、マイリストはロードできません。</p>';
                }
            } else if (tabName === 'add') {
                 if (currentMarker) map.removeLayer(currentMarker);
                 document.getElementById('coordinates').value = '';
            }
        };

    </script>
</body>
</html>
